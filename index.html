<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Chatty ‚Äì Messenger (Official) + Slot (Bank & 8 Linien)</title>
  <meta name="theme-color" content="#075E54">
  <style>
    :root{
      --bg:#0b141a;
      --panel:#111b21;
      --panel-light:#202c33;
      --accent:#075E54;
      --accent-2:#128C7E;
      --text:#e9edef;
      --muted:#8696a0;
      --me:#005c4b;
      --them:#1f2c34;
      --bubble-shadow:0 1px 1px rgba(0,0,0,.1);
      --danger:#e53935;
      --ok:#2e7d32;
      --border:#0a1014;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }
    .hidden{display:none!important}
    a{color:#34b7f1;text-decoration:none}
    .btn{background:var(--accent);border:none;color:#fff;padding:.65rem .9rem;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:var(--bubble-shadow)}
    .btn.secondary{background:var(--panel-light);border:1px solid #2a3942}
    .btn.ghost{background:transparent;border:1px solid #2a3942}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input,select,input[type="date"],input[type="tel"],input[type="search"]{
      width:100%;background:var(--panel-light);color:var(--text);
      border:1px solid #2a3942;outline:none;padding:.7rem 1rem;border-radius:10px
    }
    .label{display:block;color:var(--muted);font-size:.85rem;margin:.2rem 0 .35rem}
    .row{display:flex;gap:.6rem}.row>*{flex:1}
    .chip{background:#172229;border:1px solid #23313a;border-radius:999px;padding:.25rem .6rem;font-size:.85rem;color:#cfe5d9}

    /* Layout */
    .app{
      display:grid;
      grid-template-columns:360px 1fr;
      grid-template-rows:64px 1fr 70px;
      grid-template-areas:"sidebar header""sidebar chat""sidebar composer";
      height:100vh;max-width:1400px;margin:0 auto;background:var(--panel);
      border-left:1px solid var(--border);border-right:1px solid var(--border);overflow:hidden
    }
    .header{
      grid-area:header;background:var(--panel-light);display:flex;align-items:center;gap:.6rem;
      padding:.5rem .6rem;border-left:1px solid var(--border);position:sticky;top:0;z-index:5
    }
    .header .right{margin-left:auto;display:flex;align-items:center;gap:.4rem}
    .icon-btn{width:40px;height:40px;display:grid;place-items:center;background:#22333a;border-radius:50%;cursor:pointer;border:1px solid #2a3942}
    .icon-btn svg{width:22px;height:22px;fill:#cfd8dc}
    .logo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;background:#000;margin-right:.35rem;overflow:hidden}
    .logo svg{width:26px;height:26px}

    .sidebar{grid-area:sidebar;border-right:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;min-width:0}
    .sidebar .topbar{height:64px;display:flex;align-items:center;justify-content:space-between;padding:.5rem .6rem;background:var(--panel-light)}
    .sidebar .list{overflow:auto}
    .chat{
      grid-area:chat;background:#0f181d url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><path fill=%221d282f%22 d=%22M0 0h60v60H0z%22/><circle cx=%2210%22 cy=%2210%22 r=%222%22 fill=%22202c33%22/></svg>') repeat;
      padding:1rem;overflow:auto;display:flex;flex-direction:column;gap:.35rem
    }
    .bubble{max-width:75%;padding:.5rem .75rem;border-radius:14px;box-shadow:var(--bubble-shadow);display:inline-flex;flex-direction:column;gap:.35rem;line-height:1.3;word-break:break-word}
    .bubble.me{align-self:flex-end;background:var(--me)}
    .bubble.them{align-self:flex-start;background:var(--them)}
    .bubble .meta{font-size:.75rem;color:#d1d7dbcc;align-self:flex-end}
    .bubble img.msg-image{max-width:min(260px,70vw);border-radius:8px}
    .bubble audio{width:240px}
    .composer{grid-area:composer;background:var(--panel-light);display:flex;align-items:center;gap:.5rem;padding:.5rem;border-left:1px solid var(--border)}

    .chat-item{display:flex;gap:.6rem;padding:.6rem .75rem;cursor:pointer;align-items:center;border-bottom:1px solid var(--border)}
    .chat-item:hover{background:#172229}
    .chat-item .meta{display:flex;justify-content:space-between;width:100%}
    .chat-item .name{font-weight:600}
    .chat-item .last{color:var(--muted);font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
    .chat-item .time{color:var(--muted);font-size:.75rem}

    /* Cards */
    .center-wrap{min-height:100vh;display:grid;place-items:center;padding:1rem}
    .card{width:min(480px,95vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .pfp-lg{width:84px;height:84px;border-radius:50%;object-fit:cover;background:#2a3942;display:block}
    .inline-help{font-size:.85rem;color:var(--muted)}

    /* Modals */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:9998;padding:1rem}
    .sheet{width:min(720px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1rem;box-shadow:0 16px 60px rgba(0,0,0,.55)}
    .sheet header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:.5rem}
    .sheet h2{margin:0;font-size:1.2rem}

    /* Slot */
    .slot-wrap{background:linear-gradient(#172229,#0f171c);border:1px solid #23313a;border-radius:14px;padding:1rem}
    .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin:.25rem 0 .75rem}
    .reel{background:#11181d;border:1px solid #23313a;border-radius:12px;height:132px;overflow:hidden;position:relative;display:grid;place-items:center}
    .reel .cell{font-size:34px;line-height:1;height:44px;display:grid;place-items:center}
    .slot-controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .kpis{display:flex;gap:.5rem;flex-wrap:wrap;color:#cfe5d9;font-size:.95rem}
    .kpi{background:#172229;border:1px solid #23313a;border-radius:10px;padding:.4rem .6rem}

    /* Mobile tweaks */
    @media (max-width:900px){
      .app{grid-template-columns:1fr;grid-template-areas:"header" "chat" "composer"}
      .sidebar{display:none}
      .header{gap:.4rem}
      .reel{height:108px}
      .reel .cell{font-size:28px;height:36px}
      .slot-controls .input{max-width:98px}
    }

    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#1f2c34;color:var(--text);padding:.5rem .75rem;border-radius:10px;border:1px solid #2a3942;box-shadow:var(--bubble-shadow);z-index:9999;display:none}
  </style>
</head>
<body>

<!-- AUTH VIEW (Phone only) -->
<section id="authView" class="center-wrap">
  <div class="card">
    <h1>üì± Anmeldung mit Telefonnummer</h1>
    <p>Gib deine Nummer im internationalen Format ein (z. B. <b>+49...</b>). Danach kommt ein SMS-Code.</p>
    <label class="label" for="phoneInput">Telefonnummer</label>
    <input id="phoneInput" class="input" placeholder="+49..." inputmode="tel" type="tel" />
    <div id="recaptcha-container" style="margin:.75rem 0;"></div>
    <div id="codeBox" class="hidden" style="margin-top:.75rem">
      <label class="label" for="codeInput">SMS-Code</label>
      <input id="codeInput" class="input" placeholder="123456" inputmode="numeric" />
      <button id="verifyBtn" class="btn" style="margin-top:.5rem">Best√§tigen</button>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button id="sendCodeBtn" class="btn">SMS-Code senden</button>
    </div>
    <p class="inline-help">‚ö†Ô∏è Nutze <b>https://</b> Hosting und aktiviere in Firebase Auth die <b>Telefon-Anmeldung</b>. F√ºge deine Domain bei <i>Autorisierte Domains</i> hinzu.</p>
  </div>
</section>

<!-- PROFILE SETUP VIEW -->
<section id="profileView" class="center-wrap hidden">
  <div class="card">
    <h1>üë§ Konto erstellen</h1>
    <p>Bild, Name, Geburtstag und <b>Status</b> (sichtbar f√ºr Freunde).</p>
    <div class="row" style="align-items:center; margin:.5rem 0">
      <img id="profilePhotoPreview" class="pfp-lg" alt="Profilbild">
      <div>
        <label class="label">Profilbild</label>
        <input type="file" id="profilePhotoInput" accept="image/*" class="input" />
      </div>
    </div>
    <label class="label" for="displayName">Name</label>
    <input id="displayName" class="input" placeholder="Dein Name" />
    <div class="row" style="margin-top:.5rem">
      <div>
        <label class="label" for="birthday">Geburtstag</label>
        <input id="birthday" type="date" class="input" />
      </div>
      <div>
        <label class="label" for="about">Status</label>
        <input id="about" class="input" placeholder="Hey there! I am using Chatty." />
      </div>
    </div>
    <button id="saveProfileBtn" class="btn" style="margin-top:1rem">Speichern & weiter</button>
  </div>
</section>

<!-- MAIN APP VIEW -->
<section id="appView" class="app hidden">
  <aside class="sidebar">
    <div class="topbar">
      <div class="row" style="align-items:center;flex:1">
        <img id="mePhoto" class="pfp" alt="Ich" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
        <div>
          <div id="meName" class="title"></div>
          <div id="mePhone" class="subtitle"></div>
        </div>
      </div>
      <button id="logoutBtn" class="btn ghost" title="Abmelden">‚éã</button>
    </div>
    <div class="row" style="padding:.6rem">
      <input id="searchPhone" class="input" placeholder="Telefon (+49‚Ä¶)" inputmode="tel" type="tel"/>
    </div>
    <div class="row" style="padding:0 .6rem .6rem .6rem">
      <input id="searchName" class="input" placeholder="Name suchen" type="search"/>
      <button id="startChatBtn" class="btn">Chat</button>
    </div>
    <div id="chatList" class="list"></div>
  </aside>

  <header class="header">
    <div class="logo" title="Logo">
      <!-- neutrales wei√ües Sonnen-Icon auf schwarz -->
      <svg viewBox="0 0 100 100" aria-label="Logo" xmlns="http://www.w3.org/2000/svg">
        <rect width="100" height="100" fill="#000"/>
        <circle cx="50" cy="50" r="18" fill="#fff"/>
        <g stroke="#fff" stroke-width="6" stroke-linecap="round">
          <line x1="50" y1="6" x2="50" y2="22"/>
          <line x1="50" y1="78" x2="50" y2="94"/>
          <line x1="6" y1="50" x2="22" y2="50"/>
          <line x1="78" y1="50" x2="94" y2="50"/>
          <line x1="20" y1="20" x2="30" y2="30"/>
          <line x1="70" y1="70" x2="80" y2="80"/>
          <line x1="20" y1="80" x2="30" y2="70"/>
          <line x1="70" y1="30" x2="80" y2="20"/>
        </g>
      </svg>
    </div>
    <img id="peerPhoto" class="pfp" alt="Kontakt">
    <div>
      <div id="peerName" class="title">W√§hle einen Chat</div>
      <div id="peerSubtitle" class="subtitle"></div>
    </div>
    <div class="right">
      <!-- Search button (mobile & desktop) -->
      <button id="openSearchBtn" class="icon-btn" title="Kontakte suchen">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5-5-5zM9.5 14A4.5 4.5 0 119.5 5a4.5 4.5 0 010 9z"/></svg>
      </button>
      <!-- Toplist button (mobile quick access) -->
      <button id="openTopBtn" class="icon-btn" title="Topliste">
        <svg viewBox="0 0 24 24"><path d="M7 21v-8H3V3h8v4h2V3h8v10h-4v8H7zM5 5v6h4V5H5zm10 2v4h4V7h-4zM9 13v6h6v-6H9z"/></svg>
      </button>
      <!-- Slot button -->
      <button id="slotBtn" class="icon-btn" title="Mini-Slot">
        <svg viewBox="0 0 24 24"><path d="M3 7a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3h-1v2h-2v-2H9v2H7v-2H6a3 3 0 0 1-3-3V7zM6 6a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H6zm1.5 2.3h3v6h-3v-6zm6 0h3v6h-3v-6z"/></svg>
      </button>
      <!-- Admin button (owner only) -->
      <button id="adminBtn" class="icon-btn hidden" title="Admin">
        <svg viewBox="0 0 24 24"><path d="M12 1l3 5 6 .9-4.3 4.2 1 6L12 15l-5.7 3 1-6L3 6.9 9 6l3-5z"/></svg>
      </button>
    </div>
  </header>

  <main id="chatArea" class="chat">
    <div style="text-align:center;color:var(--muted);margin-top:1rem">Kein Chat ausgew√§hlt.</div>
  </main>

  <div class="composer">
    <label class="icon-btn" for="imageInput" title="Bild senden">
      <input id="imageInput" type="file" accept="image/*" />
      <svg viewBox="0 0 24 24"><path d="M21 19V5a2 2 0 0 0-2-2H5c-1.1 0-2 .9-2 2v14h18zM5 5h14v10l-3.5-3.5-2.5 2.5-4-4L5 13V5zm0 14h14v2H5v-2z"/></svg>
    </label>
    <button id="recBtn" class="icon-btn" title="Sprachnotiz aufnehmen">
      <svg id="micIcon" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2v-3z"/></svg>
    </button>
    <input id="msgInput" class="input grow" placeholder="Nachricht" />
    <button id="sendBtn" class="btn">Senden</button>
  </div>
</section>

<!-- SEARCH MODAL -->
<div id="searchModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Suche">
  <div class="sheet">
    <header><h2>üîé Kontakte suchen</h2><button id="searchClose" class="btn secondary">Schlie√üen</button></header>
    <div class="row">
      <input id="searchNameModal" class="input" type="search" placeholder="Name"/>
      <input id="searchPhoneModal" class="input" type="tel" inputmode="tel" placeholder="+49‚Ä¶ Telefonnummer"/>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button id="searchRunBtn" class="btn">Suchen</button>
      <button id="searchStartChatBtn" class="btn secondary">Chat starten</button>
    </div>
    <div id="searchResults" style="margin-top:.75rem"></div>
  </div>
</div>

<!-- SLOT MODAL -->
<div id="slotModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Mini Slot">
  <div class="sheet">
    <header>
      <h2>üé∞ Mini-Slot ‚Äì ‚Ç¨-Guthaben & Bank</h2>
      <div class="row" style="flex:0 0 auto">
        <button id="slotResetBtn" class="btn secondary" title="Mein Slot-Guthaben auf 500 setzen">Reset ‚Ç¨500</button>
        <button id="slotClose" class="btn secondary">Schlie√üen</button>
      </div>
    </header>
    <div class="kpis">
      <div class="kpi">Guthaben: <b id="slotBalance">‚Ç¨ 0</b></div>
      <div class="kpi">Letzter Gewinn: <b id="slotWin">‚Ç¨ 0</b></div>
      <div class="kpi">Gesamtgewinne: <b id="slotWinsTotal">‚Ç¨ 0</b></div>
    </div>
    <div class="slot-wrap">
      <div id="reels" class="reels" aria-live="polite"></div>
      <div class="slot-controls">
        <label class="label" style="width:auto">Einsatz</label>
        <select id="slotBet" class="input" style="max-width:120px">
          <option>10</option><option>20</option><option>30</option><option>40</option><option>50</option>
          <option>60</option><option>70</option><option>80</option><option>90</option><option selected>100</option>
        </select>
        <button id="slotSpin" class="btn">SPIN</button>
        <button id="slotAuto10" class="btn secondary">Autospin √ó10</button>
        <button id="slotLoanBtn" class="btn secondary" title="Bis 10.000‚Ç¨ leihen">üè¶ Leihen</button>
        <button id="slotRules" class="btn secondary">Regeln</button>
      </div>
    </div>
    <div class="leaderboard">
      <h3>üèÜ Top 10 (Gesamtgewinne)</h3>
      <div id="lb"></div>
    </div>
  </div>
</div>

<!-- TOPLIST QUICK MODAL -->
<div id="topModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Topliste">
  <div class="sheet">
    <header><h2>üèÜ Topliste</h2><button id="topClose" class="btn secondary">Schlie√üen</button></header>
    <div id="lbQuick"></div>
  </div>
</div>

<!-- ADMIN MODAL (owner only) -->
<div id="adminModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Admin">
  <div class="sheet">
    <header><h2>üõ†Ô∏è Admin-Men√º</h2><button id="adminClose" class="btn secondary">Schlie√üen</button></header>
    <div class="kpis"><div class="kpi">Bank-Saldo: <b id="bankBalanceLabel">‚Ç¨ 0</b></div></div>
    <div class="row">
      <input id="admPhone" class="input" type="tel" inputmode="tel" placeholder="+49‚Ä¶ Nutzer-Telefon"/>
      <input id="admAmount" class="input" type="number" placeholder="Betrag (‚Ç¨)"/>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button id="admGrantBtn" class="btn">Guthaben geben</button>
      <button id="admSet500AllBtn" class="btn secondary" title="Setzt bis zu 500 Nutzer auf 500‚Ç¨">Alle auf 500‚Ç¨ (bis 500)</button>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button id="admBankInitBtn" class="btn ghost" title="Bank initialisieren/auff√ºllen">Bank auf 1.000.000.000‚Ç¨ setzen</button>
      <button id="admRefreshBtn" class="btn secondary">Aktualisieren</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>

<script>
  // === Firebase-Konfiguration (deine Daten) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDN1MZv_q38Zoymt92BHWTe9sUNwteT1KA",
    authDomain: "sample-firebase-ai-app-b02a4.firebaseapp.com",
    projectId: "sample-firebase-ai-app-b02a4",
    storageBucket: "sample-firebase-ai-app-b02a4.firebasestorage.app",
    messagingSenderId: "382050648468",
    appId: "1:382050648468:web:8c6f34051a7b2991ebcf81"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  const $ = sel => document.querySelector(sel);
  const toast = (msg, ms=2500) => { const el = $("#toast"); el.textContent = msg; el.style.display="block"; setTimeout(()=> el.style.display="none", ms); };

  // Elements
  const authView = $("#authView"), profileView = $("#profileView"), appView = $("#appView");
  const phoneInput = $("#phoneInput"), sendCodeBtn = $("#sendCodeBtn"), codeBox=$("#codeBox"), codeInput=$("#codeInput"), verifyBtn=$("#verifyBtn");
  const profilePhotoInput=$("#profilePhotoInput"), profilePhotoPreview=$("#profilePhotoPreview"), displayNameInput=$("#displayName"), birthdayInput=$("#birthday"), aboutInput=$("#about"), saveProfileBtn=$("#saveProfileBtn");
  const mePhoto=$("#mePhoto"), meName=$("#meName"), mePhone=$("#mePhone"), logoutBtn=$("#logoutBtn");
  const chatList=$("#chatList"), searchPhone=$("#searchPhone"), searchName=$("#searchName"), startChatBtn=$("#startChatBtn");
  const peerPhoto=$("#peerPhoto"), peerName=$("#peerName"), peerSubtitle=$("#peerSubtitle");
  const chatArea=$("#chatArea"), imageInput=$("#imageInput"), recBtn=$("#recBtn"), micIcon=$("#micIcon"), msgInput=$("#msgInput"), sendBtn=$("#sendBtn");

  const openSearchBtn=$("#openSearchBtn"), searchModal=$("#searchModal"), searchClose=$("#searchClose"), searchNameModal=$("#searchNameModal"), searchPhoneModal=$("#searchPhoneModal"), searchRunBtn=$("#searchRunBtn"), searchStartChatBtn=$("#searchStartChatBtn"), searchResults=$("#searchResults");
  const openTopBtn=$("#openTopBtn"), topModal=$("#topModal"), topClose=$("#topClose");
  const adminBtn=$("#adminBtn"), adminModal=$("#adminModal"), adminClose=$("#adminClose"), bankBalanceLabel=$("#bankBalanceLabel"), admPhone=$("#admPhone"), admAmount=$("#admAmount"), admGrantBtn=$("#admGrantBtn"), admSet500AllBtn=$("#admSet500AllBtn"), admBankInitBtn=$("#admBankInitBtn"), admRefreshBtn=$("#admRefreshBtn");

  // Slot
  const slotBtn=$("#slotBtn"), slotModal=$("#slotModal"), slotClose=$("#slotClose"), slotSpin=$("#slotSpin"), slotAuto10=$("#slotAuto10"), slotBetSel=$("#slotBet"), slotBalanceEl=$("#slotBalance"), slotWinsTotalEl=$("#slotWinsTotal"), slotWinEl=$("#slotWin"), reelsEl=$("#reels"), lbEl=$("#lb"), slotRulesBtn=$("#slotRules"), slotResetBtn=$("#slotResetBtn"), slotLoanBtn=$("#slotLoanBtn"), lbQuick=$("#lbQuick");

  // State
  let confirmationResult=null, me=null, activeThreadId=null, activePeer=null, messagesUnsub=null, threadsUnsub=null;
  let recorder=null, recChunks=[], isRecording=false;

  // Slot/Game state
  const OWNER_PHONE = "+491722529605";
  const SYMS=["üçí","üçã","üçá","üîî","‚≠ê","7Ô∏è‚É£"];
  const BASELINE_BET=10, BASE_WIN_THREE=50, BASE_WIN_TWO=10, BASE_WIN_FULL=1000; // Baseline bei Einsatz 10
  let slotBalance=0, slotWinsTotal=0, autospinLeft=0, spinning=false;

  function fmtEUR(v){ return "‚Ç¨ " + (Math.round(v).toLocaleString()); }

  function showView(which){ authView.classList.add("hidden"); profileView.classList.add("hidden"); appView.classList.add("hidden"); if(which==="auth")authView.classList.remove("hidden"); if(which==="profile")profileView.classList.remove("hidden"); if(which==="app")appView.classList.remove("hidden"); }

  // Phone auth only (no demo)
  let recaptchaVerifier=null;
  const setupRecaptcha=()=>{ try{ if(recaptchaVerifier) return; recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'normal'}); recaptchaVerifier.render(); }catch(e){ console.warn('reCAPTCHA init failed', e);} };
  setupRecaptcha();

  sendCodeBtn.addEventListener('click', async ()=>{
    const phone=(phoneInput.value||"").trim();
    if(!phone.startsWith('+')){ toast('Bitte im Format +49‚Ä¶'); return; }
    try{
      await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
      confirmationResult = await auth.signInWithPhoneNumber(phone, recaptchaVerifier);
      codeBox.classList.remove('hidden'); toast('SMS gesendet.');
    }catch(err){ console.error(err); toast('Fehler: ' + (err.message||err)); }
  });
  verifyBtn.addEventListener('click', async ()=>{
    const code=(codeInput.value||"").trim();
    if(!confirmationResult){ toast('Zuerst Code senden.'); return; }
    try{ await confirmationResult.confirm(code); toast('Angemeldet.'); }
    catch(err){ console.error(err); toast('Code falsch/abgelaufen.'); }
  });

  auth.onAuthStateChanged(async (user)=>{
    if(!user){ showView('auth'); return; }
    const doc = await db.collection('users').doc(user.uid).get();
    me = doc.exists ? doc.data() : null;
    if(!me){ showView('profile'); }
    else { showView('app'); renderMe(me); startThreadsListener(); await loadEconomy(); checkOwner(user); }
  });

  function checkOwner(user){
    if(user?.phoneNumber === OWNER_PHONE){ adminBtn.classList.remove('hidden'); }
  }

  logoutBtn.addEventListener('click', async ()=>{
    try{ await auth.signOut(); cleanupThreadListener(); cleanupThreadsListener(); me=null; activePeer=null; activeThreadId=null; chatArea.innerHTML = '<div style="text-align:center;color:var(--muted);margin-top:1rem">Kein Chat ausgew√§hlt.</div>'; }
    catch(e){ console.error(e); }
  });

  // Profile
  profilePhotoInput.addEventListener('change', ()=>{
    const f=profilePhotoInput.files?.[0]; if(!f){ profilePhotoPreview.src=''; return; }
    const r=new FileReader(); r.onload=e=>profilePhotoPreview.src=e.target.result; r.readAsDataURL(f);
  });
  saveProfileBtn.addEventListener('click', async ()=>{
    try{
      const user=auth.currentUser; if(!user){ toast('Nicht angemeldet.'); return; }
      let name=(displayNameInput.value||'').trim(); if(!name){ name = user.phoneNumber ? ('User '+user.phoneNumber) : 'User'; displayNameInput.value=name; }
      const birthday=birthdayInput.value||null;
      const about=(aboutInput.value||'').trim()||null;
      let photoURL=null;
      const f=profilePhotoInput.files?.[0]||null;
      if(f){ try{ const ext=(f.name.split('.').pop()||'jpg'); const ref=storage.ref().child(`pfp/${user.uid}.${ext}`); await ref.put(f); photoURL=await ref.getDownloadURL(); }catch(e){ console.warn('Bild-Upload fehlgeschlagen',e); } }
      const profile={ uid:user.uid, phoneNumber:user.phoneNumber||null, name, birthday, about, photoURL:photoURL||null, createdAt:firebase.firestore.FieldValue.serverTimestamp(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() };
      await db.collection('users').doc(user.uid).set(profile,{merge:true});
      me={...(me||{}),...profile};
      renderMe(me); showView('app'); startThreadsListener(); await loadEconomy(); checkOwner(user);
      toast('Profil gespeichert.');
    }catch(e){ console.error(e); toast('Konnte Profil nicht speichern.'); }
  });

  function renderMe(profile){
    mePhoto.src = profile.photoURL || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(profile.name||'Ich'));
    meName.textContent = profile.name || 'Ich';
    mePhone.textContent = profile.phoneNumber || 'Telefon';
  }

  // Threads & chat list
  function startThreadsListener(){
    cleanupThreadsListener();
    const user=auth.currentUser; if(!user) return;
    threadsUnsub = db.collection('threads').where('participants','array-contains',user.uid).orderBy('lastMessageAt','desc').limit(50).onSnapshot(snap=>{
      chatList.innerHTML='';
      snap.forEach(doc=>{
        const t=doc.data(); const peerId=t.participants.find(id=>id!==user.uid); renderChatItem(doc.id,t,peerId);
      });
    });
  }
  function cleanupThreadsListener(){ if(threadsUnsub){ threadsUnsub(); threadsUnsub=null; }}

  async function renderChatItem(threadId,t,peerId){
    const peerDoc=await db.collection('users').doc(peerId).get();
    const peer=peerDoc.data()||{name:'Unbekannt',photoURL:null,phoneNumber:'?'};
    const div=document.createElement('div'); div.className='chat-item';
    div.innerHTML=`<img class="pfp" src="${peer.photoURL||('https://ui-avatars.com/api/?name='+encodeURIComponent(peer.name))}" alt="pfp"><div class="meta"><div><div class="name">${peer.name}</div><div class="last">${t.lastMessageText || (t.lastMessageType==='image'?'üñºÔ∏è Bild':t.lastMessageType==='audio'?'üé§ Sprachnotiz':'') || ''}</div></div><div class="time">${formatTime(t.lastMessageAt?.toDate?.())}</div></div>`;
    div.addEventListener('click',()=>openThread(threadId,peer)); chatList.appendChild(div);
  }
  function formatTime(d){ if(!d) return ''; const now=new Date(); const sameDay=d.toDateString()===now.toDateString(); return sameDay? d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : d.toLocaleDateString(); }

  // Start chat (sidebar)
  startChatBtn.addEventListener('click', async ()=>{
    const phone=(searchPhone.value||'').trim();
    const name=(searchName.value||'').trim().toLowerCase();
    let peer=null;
    if(phone.startsWith('+')) peer = await findUserByPhone(phone);
    if(!peer && name){ peer = await findUserByName(name); }
    if(!peer){ toast('Kein Nutzer gefunden.'); return; }
    const threadId=await ensureThread(auth.currentUser.uid, peer.uid, me.phoneNumber, peer.phoneNumber);
    await openThread(threadId, peer); searchPhone.value=''; searchName.value=''; toast('Chat ge√∂ffnet.');
  });

  async function findUserByPhone(phone){ const q=await db.collection('users').where('phoneNumber','==', phone).limit(1).get(); if(q.empty) return null; return q.docs[0].data(); }
  async function findUserByName(nameLower){ const q=await db.collection('users').orderBy('name').startAt(nameLower).endAt(nameLower + '\uf8ff').limit(5).get(); if(q.empty) return null; return q.docs[0].data(); }
  function makeThreadId(a,b){ return [a,b].sort().join('_'); }
  async function ensureThread(uidA,uidB,phoneA,phoneB){
    const id=makeThreadId(uidA,uidB); const ref=db.collection('threads').doc(id); const snap=await ref.get();
    if(!snap.exists){ await ref.set({participants:[uidA,uidB],phones:[phoneA||null,phoneB||null],createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageText:'',lastMessageType:''}); }
    return id;
  }
  async function openThread(threadId,peer){
    activeThreadId=threadId; activePeer=peer;
    peerPhoto.src=peer.photoURL||('https://ui-avatars.com/api/?name='+encodeURIComponent(peer.name||'?'));
    peerName.textContent=peer.name||peer.phoneNumber||'Kontakt'; peerSubtitle.textContent=peer.phoneNumber||'';
    chatArea.innerHTML=''; startMessagesListener(threadId);
  }
  function startMessagesListener(threadId){
    cleanupThreadListener();
    messagesUnsub=db.collection('threads').doc(threadId).collection('messages').orderBy('ts','asc').limit(200).onSnapshot(snap=>{
      chatArea.innerHTML=''; snap.forEach(doc=>renderMessage(doc.data())); chatArea.scrollTop=chatArea.scrollHeight;
    });
  }
  function cleanupThreadListener(){ if(messagesUnsub){ messagesUnsub(); messagesUnsub=null; }}

  function renderMessage(m){
    const div=document.createElement('div'); div.className='bubble '+(m.senderId===auth.currentUser?.uid?'me':'them');
    if(m.text){ const p=document.createElement('div'); p.textContent=m.text; div.appendChild(p); }
    if(m.imageUrl){ const img=document.createElement('img'); img.className='msg-image'; img.src=m.imageUrl; img.alt='Bild'; div.appendChild(img); }
    if(m.audioUrl){ const audio=document.createElement('audio'); audio.controls=true; audio.src=m.audioUrl; div.appendChild(audio); }
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=formatTime(m.ts?.toDate?.()); div.appendChild(meta);
    chatArea.appendChild(div);
  }

  // Send text / image / audio
  sendBtn.addEventListener('click', sendText);
  msgInput.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }});
  async function sendText(){ const text=(msgInput.value||'').trim(); if(!text) return; if(!activeThreadId){ toast('W√§hle zuerst einen Chat.'); return; } msgInput.value=''; await pushMessage({ text }); }
  imageInput.addEventListener('change', async ()=>{ const f=imageInput.files?.[0]; if(!f) return; if(!activeThreadId){ toast('W√§hle zuerst einen Chat.'); imageInput.value=''; return; } try{ const url=await uploadFile(f,'images'); await pushMessage({ imageUrl:url, type:'image' }); imageInput.value=''; }catch(e){ console.error(e); toast('Upload fehlgeschlagen.'); } });
  recBtn.addEventListener('click', async ()=>{
    if(isRecording){ recorder?.stop(); isRecording=false; micIcon.style.opacity=1; return; }
    if(!activeThreadId){ toast('W√§hle zuerst einen Chat.'); return; }
    try{
      const stream=await navigator.mediaDevices.getUserMedia({audio:true}); recChunks=[]; recorder=new MediaRecorder(stream);
      recorder.ondataavailable=e=>{ if(e.data.size>0) recChunks.push(e.data); };
      recorder.onstop=async()=>{ const blob=new Blob(recChunks,{type:'audio/webm'}); const file=new File([blob],`voice_${Date.now()}.webm`,{type:'audio/webm'}); const url=await uploadFile(file,'audio'); await pushMessage({audioUrl:url, type:'audio'}); };
      recorder.start(); isRecording=true; micIcon.style.opacity=.6; toast('üé§ Aufnahme‚Ä¶ erneut tippen zum Beenden.');
    }catch(e){ console.error(e); toast('Mikrofonzugriff verweigert.'); }
  });

  async function uploadFile(file,folder){ const uid=auth.currentUser.uid; const safe=(file.name||'file').replace(/[^a-z0-9\._-]+/gi,'_').toLowerCase(); const ref=storage.ref().child(`${folder}/${uid}/${Date.now()}_${safe}`); await ref.put(file); return await ref.getDownloadURL(); }
  async function pushMessage({text=null,imageUrl=null,audioUrl=null,type=null}){
    const user=auth.currentUser; if(!user||!activeThreadId) return;
    const msg={senderId:user.uid,text:text||null,imageUrl:imageUrl||null,audioUrl:audioUrl||null,ts:firebase.firestore.FieldValue.serverTimestamp(),type:type||(imageUrl?'image':audioUrl?'audio':'text')};
    const ref=db.collection('threads').doc(activeThreadId).collection('messages').doc(); await ref.set(msg);
    await db.collection('threads').doc(activeThreadId).set({lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageText:text||(imageUrl?'üñºÔ∏è Bild':audioUrl?'üé§ Sprachnotiz':''),lastMessageType:msg.type},{merge:true});
  }

  // ===== Economy & Bank =====
  async function getBankDoc(){ const ref=db.collection('economy').doc('bank'); const snap=await ref.get(); if(!snap.exists){ await ref.set({ bankBalance: 1000000000, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), createdAt: firebase.firestore.FieldValue.serverTimestamp() }); return (await ref.get()).data(); } return snap.data(); }
  async function setBankBalance(val){ await db.collection('economy').doc('bank').set({ bankBalance: Math.max(0, Math.floor(val)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); }
  async function loadEconomy(){
    const user=auth.currentUser; if(!user) return;
    const bank=await getBankDoc(); bankBalanceLabel.textContent = fmtEUR(bank.bankBalance||0);
    const doc=await db.collection('users').doc(user.uid).get(); const data=doc.exists?doc.data():{};
    slotBalance = Number.isFinite(data.slotBalance) ? data.slotBalance : (data.slotPoints||0);
    slotWinsTotal = Number.isFinite(data.slotWinsTotal) ? data.slotWinsTotal : 0;
    const lastGrantDate = data.slotLastGrantDate || null;
    const today=new Date(), yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0'); const todayKey=`${yyyy}-${mm}-${dd}`;
    if(lastGrantDate !== todayKey){
      slotBalance += 500;
      await db.collection('users').doc(user.uid).set({ slotBalance, slotLastGrantDate: todayKey }, { merge:true });
      toast('Tagesguthaben +500 hinzugef√ºgt.');
    }
    updateEconomyUI();
  }
  function updateEconomyUI(){ slotBalanceEl.textContent=fmtEUR(slotBalance); slotWinsTotalEl.textContent=fmtEUR(slotWinsTotal); }
  async function saveEconomy(){ const user=auth.currentUser; if(!user) return; await db.collection('users').doc(user.uid).set({ slotBalance, slotWinsTotal, updatedAt:firebase.firestore.FieldValue.serverTimestamp(), slotPoints: slotBalance }, { merge:true }); updateEconomyUI(); }

  // Slot UI events
  async function openSlot(){ await loadEconomy(); buildReelsGrid(randomGrid()); slotWinEl.textContent=fmtEUR(0); updateEconomyUI(); renderLeaderboard(); slotModal.classList.remove('hidden'); }
  slotBtn.addEventListener('click', async ()=>{ await openSlot(); });
  slotClose.addEventListener('click', ()=>{ autospinLeft=0; slotModal.classList.add('hidden'); });
  slotRulesBtn.addEventListener('click', ()=>{
    alert('Regeln:\n- 3√ó3 Slot: Reihen, Spalten & Diagonalen z√§hlen als Linien (8 Gesamt).\n- Einsatz w√§hlbar (10‚Äì100); Gewinn skaliert mit Einsatz.\n- Pro Linie: 3 gleiche = Baseline ‚Ç¨50 (bei Einsatz 10); 2 gleiche = Baseline ‚Ç¨10.\n- Alle g√ºltigen Linien werden addiert.\n- Bei mind. einer 3er-Linie bis zu 2 Re-Spins (Ziel: Vollbild).\n- Vollbild = Baseline ‚Ç¨1000 (bei Einsatz 10).\n- Bank: Einsatz zur Bank, Gewinne von der Bank.\n- Leihen bis 10.000‚Ç¨ (sofern Bank genug hat).');
  });
  slotResetBtn.addEventListener('click', async ()=>{ slotBalance=500; await saveEconomy(); toast('Dein Slot-Guthaben wurde auf ‚Ç¨ 500 gesetzt.'); });
  slotLoanBtn.addEventListener('click', async ()=>{
    const amtStr = prompt('Wie viel ‚Ç¨ leihen? (max. 10000)'); if(!amtStr) return;
    let amt = Math.max(0, Math.floor(+amtStr||0)); if(amt<=0) return;
    if(amt>10000) amt=10000;
    const bank = await getBankDoc();
    if((bank.bankBalance||0) < amt){ toast('Bank kann aktuell nicht so viel auszahlen.'); return; }
    slotBalance += amt; await saveEconomy(); await setBankBalance((bank.bankBalance||0)-amt); bankBalanceLabel.textContent=fmtEUR((bank.bankBalance||0)-amt); toast('Leihe ausgezahlt: '+fmtEUR(amt));
  });

  // Top modal quick button
  openTopBtn.addEventListener('click', async ()=>{ await renderLeaderboardQuick(); topModal.classList.remove('hidden'); });
  topClose.addEventListener('click', ()=> topModal.classList.add('hidden'));

  // Search modal
  openSearchBtn.addEventListener('click', ()=>{ searchModal.classList.remove('hidden'); searchResults.innerHTML=''; });
  searchClose.addEventListener('click', ()=> searchModal.classList.add('hidden'));
  searchRunBtn.addEventListener('click', async ()=>{
    const name=(searchNameModal.value||'').trim().toLowerCase();
    const phone=(searchPhoneModal.value||'').trim();
    let out=[];
    if(phone.startsWith('+')){
      const u=await findUserByPhone(phone); if(u) out.push(u);
    }
    if(name){
      const q=await db.collection('users').orderBy('name').startAt(name).endAt(name+'\uf8ff').limit(10).get();
      q.forEach(d=> out.push(d.data()));
    }
    // render
    if(out.length===0){ searchResults.innerHTML='<div class="kpi">Nichts gefunden.</div>'; return; }
    searchResults.innerHTML = out.map(u=>`<div class="kpi" data-uid="${u.uid}" data-phone="${u.phoneNumber||''}" data-name="${u.name||''}">${u.name||'Anonym'} ‚Äî ${u.phoneNumber||''}</div>`).join('');
    Array.from(searchResults.children).forEach(el=>{ el.addEventListener('click', ()=>{ searchResults.querySelectorAll('.kpi').forEach(k=>k.style.outline=''); el.style.outline='2px solid #34b7f1'; searchResults.setAttribute('data-selected-uid', el.getAttribute('data-uid')); }); });
  });
  searchStartChatBtn.addEventListener('click', async ()=>{
    const uid=searchResults.getAttribute('data-selected-uid'); if(!uid){ toast('Bitte Ergebnis ausw√§hlen.'); return; }
    const peerDoc=await db.collection('users').doc(uid).get(); if(!peerDoc.exists){ toast('Nutzer nicht mehr verf√ºgbar.'); return; }
    const peer=peerDoc.data(); const threadId=await ensureThread(auth.currentUser.uid, peer.uid, me.phoneNumber, peer.phoneNumber); await openThread(threadId, peer); searchModal.classList.add('hidden');
  });

  // Reels helpers (8 lines, 2er/3er eval)
  function buildReelsGrid(grid){
    reelsEl.innerHTML='';
    for(let c=0;c<3;c++){
      const col=document.createElement('div'); col.className='reel';
      for(let r=0;r<3;r++){
        const cell=document.createElement('div'); cell.className='cell'; cell.textContent=grid[r][c];
        col.appendChild(cell);
      }
      reelsEl.appendChild(col);
    }
  }
  function randomGrid(){
    const g=[[],[],[]];
    for(let c=0;c<3;c++){
      for(let r=0;r<3;r++){
        g[r][c]=SYMS[Math.floor(Math.random()*SYMS.length)];
      }
    }
    return g;
  }
  function isFullScreen(grid){
    const f=grid[0][0];
    for(let r=0;r<3;r++){ for(let c=0;c<3;c++){ if(grid[r][c]!==f) return false; } }
    return true;
  }

  slotSpin.addEventListener('click', async ()=>{ autospinLeft=0; await triggerSpin(); });
  slotAuto10.addEventListener('click', async ()=>{ if(spinning) return; autospinLeft=10; await triggerSpin(); });

  async function triggerSpin(){
    if(spinning) return;
    const bet=parseInt(slotBetSel.value||'10',10);
    if(slotBalance < bet){ toast('Nicht genug Guthaben.'); autospinLeft=0; return; }
    // Deduct from user, credit bank
    slotBalance -= bet; await saveEconomy();
    const bank=await getBankDoc(); await setBankBalance((bank.bankBalance||0)+bet); bankBalanceLabel.textContent=fmtEUR((bank.bankBalance||0)+bet);

    spinning=true; slotSpin.disabled=true;
    let steps=10; const timer=setInterval(()=>{ buildReelsGrid(randomGrid()); steps--; if(steps<=0){ clearInterval(timer); finishSpin(bet); } }, 90);
  }

  async function finishSpin(bet){
    // initial
    let grid = randomGrid();
    buildReelsGrid(grid);

    // 8 Linien (3 Reihen, 3 Spalten, 2 Diagonalen)
    const LINES = [
      [[0,0],[0,1],[0,2]],
      [[1,0],[1,1],[1,2]],
      [[2,0],[2,1],[2,2]],
      [[0,0],[1,0],[2,0]],
      [[0,1],[1,1],[2,1]],
      [[0,2],[1,2],[2,2]],
      [[0,0],[1,1],[2,2]],
      [[0,2],[1,1],[2,0]]
    ];
    const at=(r,c)=>grid[r][c];

    // Auswertung: addiere ALLE Liniengewinne (2er und 3er)
    let baseWin = 0;
    let threeHitSym = null;
    for(const line of LINES){
      const s0=at(line[0][0],line[0][1]), s1=at(line[1][0],line[1][1]), s2=at(line[2][0],line[2][1]);
      if(s0===s1 && s1===s2){
        baseWin += BASE_WIN_THREE;
        if(!threeHitSym) threeHitSym = s0;
      } else if(s0===s1 || s1===s2 || s0===s2){
        baseWin += BASE_WIN_TWO;
      }
    }

    // Respins Richtung Vollbild nur wenn mind. eine 3er-Linie gefallen ist
    if(threeHitSym){
      let respins=2;
      while(respins-- > 0){
        for(let r=0;r<3;r++){
          for(let c=0;c<3;c++){
            if(grid[r][c]!==threeHitSym){
              grid[r][c] = (Math.random()<0.5) ? threeHitSym : SYMS[Math.floor(Math.random()*SYMS.length)];
            }
          }
        }
        buildReelsGrid(grid);
        if(isFullScreen(grid)){ baseWin += BASE_WIN_FULL; break; }
      }
    }

    // Skalieren mit Einsatz
    const mult=Math.max(1, bet/BASELINE_BET);
    let win = Math.round(baseWin * mult);

    // Auszahlung aus Bank (sofern genug Saldo)
    if(win>0){
      const bank=await getBankDoc();
      const pay = Math.min(win, bank.bankBalance||0);
      if(pay>0){
        slotBalance += pay; slotWinsTotal += pay; await saveEconomy();
        await setBankBalance((bank.bankBalance||0)-pay); bankBalanceLabel.textContent=fmtEUR((bank.bankBalance||0)-pay);
        if(pay<win){ toast('Bank hat nicht genug ‚Äì Teilgewinn ausgezahlt.'); }
      } else {
        toast('Bank leer ‚Äì kein Gewinn auszahlbar.');
        win=0;
      }
    }

    slotWinEl.textContent = fmtEUR(win);
    spinning=false; slotSpin.disabled=false;
    renderLeaderboard();

    // Autospin
    if(autospinLeft>0){
      autospinLeft--;
      const nextBet=parseInt(slotBetSel.value||'10',10);
      if(slotBalance>=nextBet){ setTimeout(()=>{ triggerSpin(); }, 350); }
      else { autospinLeft=0; toast('Autospin gestoppt ‚Äì Guthaben zu niedrig.'); }
    }
  }

  async function renderLeaderboard(){
    try{
      const q=await db.collection('users').orderBy('slotWinsTotal','desc').limit(10).get();
      lbEl.innerHTML=''; let i=1;
      q.forEach(doc=>{ const u=doc.data(); const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div>#${i}</div><div>${u.name||'Anonym'}</div><div>${fmtEUR(u.slotWinsTotal||0)}</div>`; lbEl.appendChild(row); i++; });
    }catch(e){ lbEl.innerHTML='<div class="row"><div>Topliste erscheint, sobald Gewinne vorhanden sind.</div></div>'; }
  }
  async function renderLeaderboardQuick(){
    try{
      const q=await db.collection('users').orderBy('slotWinsTotal','desc').limit(10).get();
      lbQuick.innerHTML=''; let i=1;
      q.forEach(doc=>{ const u=doc.data(); const row=document.createElement('div'); row.className='row'; row.innerHTML=`<div>#${i}</div><div>${u.name||'Anonym'}</div><div>${fmtEUR(u.slotWinsTotal||0)}</div>`; lbQuick.appendChild(row); i++; });
    }catch(e){ lbQuick.innerHTML='<div class="row"><div>Topliste erscheint, sobald Gewinne vorhanden sind.</div></div>'; }
  }

  // Admin menu
  adminBtn.addEventListener('click', async ()=>{ await refreshAdmin(); adminModal.classList.remove('hidden'); });
  adminClose.addEventListener('click', ()=> adminModal.classList.add('hidden'));
  admRefreshBtn.addEventListener('click', refreshAdmin);
  async function refreshAdmin(){ const bank=await getBankDoc(); bankBalanceLabel.textContent=fmtEUR(bank.bankBalance||0); }

  admBankInitBtn.addEventListener('click', async ()=>{ await setBankBalance(1000000000); await refreshAdmin(); toast('Bank auf 1.000.000.000‚Ç¨ gesetzt.'); });
  admGrantBtn.addEventListener('click', async ()=>{
    const phone=(admPhone.value||'').trim(); const amt=Math.floor(+admAmount.value||0); if(!phone.startsWith('+') || amt<=0){ toast('Telefon + Betrag angeben.'); return; }
    const q=await db.collection('users').where('phoneNumber','==', phone).limit(1).get(); if(q.empty){ toast('Nutzer nicht gefunden.'); return; }
    const id=q.docs[0].id; const data=q.docs[0].data(); const cur=data.slotBalance||0;
    await db.collection('users').doc(id).set({ slotBalance: cur + amt }, { merge:true });
    toast('Guthaben gutgeschrieben.');
  });
  admSet500AllBtn.addEventListener('click', async ()=>{
    const q=await db.collection('users').limit(500).get();
    const batch=db.batch(); q.forEach(doc=> batch.set(doc.ref, { slotBalance: 500 }, { merge:true }));
    await batch.commit(); toast('Bis zu 500 Nutzer auf 500‚Ç¨ gesetzt.');
  });

  // Search modal auto helpers
  profilePhotoPreview.src='https://ui-avatars.com/api/?name=Du';
  if(location.protocol!=='https:' && location.hostname!=='localhost'){ toast('Tipp: F√ºr Telefon-Login brauchst du HTTPS/Hosting.', 5000); }
</script>

<!--
Sicherheit/Regeln:
- Telefon-Login via Firebase Auth (SMS). Demo-Login ist entfernt.
- Bank: economy/bank.bankBalance ‚Äì Eins√§tze drauf, Gewinne runter; Leihe bis 10.000‚Ç¨, nur wenn Bank genug hat.
- T√§glicher Bonus +500‚Ç¨ pro Nutzer (Clientzeit).
- Topliste z√§hlt kumulierte GEWINNE (keine Eins√§tze).
- Admin ist die Telefonnummer +491722529605.

Empfohlene Firestore/Storage Rules (anpassen in der Konsole):
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }
    match /users/{uid} {
      allow read: if isSignedIn();
      allow write: if isOwner(uid);
    }
    match /threads/{threadId} {
      allow read, update, delete: if isSignedIn() && (request.resource.data.participants.hasAny([request.auth.uid]) ||
                                                      resource.data.participants.hasAny([request.auth.uid]));
      allow create: if isSignedIn() && request.resource.data.participants.size() == 2 && request.resource.data.participants.hasAll([request.auth.uid]);
      match /messages/{msgId} {
        allow read, create: if isSignedIn() && get(/databases/$(database)/documents/threads/$(threadId)).data.participants.hasAny([request.auth.uid]);
        allow delete, update: if false;
      }
    }
    match /economy/{docId} {
      allow read: if isSignedIn();
      // F√ºr echte Produktion: nur Admin schreiben lassen (Custom Claims/UID pr√ºfen)
      allow write: if isSignedIn();
    }
  }
}
-->
</body>
</html>
