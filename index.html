<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Chatty – Messenger + Slot + Bank</title>
  <meta name="theme-color" content="#075E54">
  <style>
    :root{
      --bg:#0b141a; --panel:#111b21; --panel-light:#202c33; --accent:#075E54; --accent-2:#128C7E;
      --text:#e9edef; --muted:#8696a0; --me:#005c4b; --them:#1f2c34; --bubble-shadow:0 1px 1px rgba(0,0,0,.1);
      --danger:#e53935; --ok:#2e7d32; --border:#0a1014;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:16px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
    .hidden{display:none!important} a{color:#34b7f1;text-decoration:none}
    .btn{background:var(--accent);border:none;color:#fff;padding:.55rem .85rem;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:var(--bubble-shadow)}
    .btn.secondary{background:var(--panel-light);border:1px solid #2a3942}
    .btn.ghost{background:transparent;border:1px solid #2a3942}
    .btn.danger{background:var(--danger)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .input,select,input[type="date"],input[type="email"],input[type="password"],input[type="search"],input[type="number"]{
      width:100%;background:var(--panel-light);color:var(--text);border:1px solid #2a3942;outline:none;padding:.6rem .8rem;border-radius:10px
    }
    .small{width:90px}
    .label{display:block;color:var(--muted);font-size:.85rem;margin:.2rem 0 .35rem}
    .row{display:flex;gap:.6rem;align-items:center}.row>*{flex:1}
    .chip{background:#172229;border:1px solid #23313a;border-radius:999px;padding:.25rem .6rem;font-size:.85rem;color:#cfe5d9}

    .app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:64px 1fr 70px;grid-template-areas:"sidebar header""sidebar chat""sidebar composer";height:100vh;max-width:1400px;margin:0 auto;background:var(--panel);border-left:1px solid var(--border);border-right:1px solid var(--border);overflow:hidden}
    .header{grid-area:header;background:var(--panel-light);display:flex;align-items:center;gap:.6rem;padding:.5rem .6rem;border-left:1px solid var(--border)}
    .header .right{margin-left:auto;display:flex;align-items:center;gap:.4rem}
    .icon-btn{width:40px;height:40px;display:grid;place-items:center;background:#22333a;border-radius:50%;cursor:pointer;border:1px solid #2a3942}
    .icon-btn svg{width:22px;height:22px;fill:#cfd8dc}
    .logo{width:32px;height:32px;border-radius:8px;display:grid;place-items:center;background:#000;margin-right:.35rem;overflow:hidden}
    .logo svg{width:26px;height:26px}
    .sidebar{grid-area:sidebar;border-right:1px solid var(--border);background:var(--panel);display:flex;flex-direction:column;min-width:0}
    .sidebar .topbar{height:64px;display:flex;align-items:center;justify-content:space-between;padding:.5rem .6rem;background:var(--panel-light)}
    .sidebar .list{overflow:auto}
    .chat{grid-area:chat;background:#0f181d;padding:1rem;overflow:auto;display:flex;flex-direction:column;gap:.35rem}
    .bubble{max-width:75%;padding:.5rem .75rem;border-radius:14px;box-shadow:var(--bubble-shadow);display:inline-flex;flex-direction:column;gap:.35rem;line-height:1.3;word-break:break-word}
    .bubble.me{align-self:flex-end;background:var(--me)}
    .bubble.them{align-self:flex-start;background:var(--them)}
    .bubble .meta{font-size:.75rem;color:#d1d7dbcc;align-self:flex-end}
    .bubble img.msg-image{max-width:min(260px,70vw);border-radius:8px}
    .bubble audio{width:240px}
    .composer{grid-area:composer;background:var(--panel-light);display:flex;align-items:center;gap:.5rem;padding:.5rem;border-left:1px solid var(--border)}

    .chat-item{display:flex;gap:.6rem;padding:.6rem .75rem;cursor:pointer;align-items:center;border-bottom:1px solid var(--border)}
    .chat-item:hover{background:#172229}
    .chat-item .meta{display:flex;justify-content:space-between;width:100%}
    .chat-item .name{font-weight:600}
    .chat-item .last{color:var(--muted);font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
    .chat-item .time{color:var(--muted);font-size:.75rem}

    .center-wrap{min-height:100vh;display:grid;place-items:center;padding:1rem}
    .card{width:min(480px,95vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .pfp-lg{width:84px;height:84px;border-radius:50%;object-fit:cover;background:#2a3942;display:block}
    .inline-help{font-size:.85rem;color:#cfd8dc}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:9998;padding:1rem}
    .sheet{width:min(900px,96vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1rem;box-shadow:0 16px 60px rgba(0,0,0,.55)}
    .sheet header{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:.5rem}
    .sheet h2{margin:0;font-size:1.2rem}

    .slot-wrap{background:linear-gradient(#172229,#0f171c);border:1px solid #23313a;border-radius:14px;padding:1rem}
    .reels{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin:.25rem 0 .75rem}
    .reel{background:#11181d;border:1px solid #23313a;border-radius:12px;height:132px;overflow:hidden;position:relative;display:grid;place-items:center}
    .reel .cell{font-size:34px;line-height:1;height:44px;display:grid;place-items:center}
    .slot-controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .kpis{display:flex;gap:.5rem;flex-wrap:wrap;color:#cfe5d9;font-size:.95rem}
    .kpi{background:#172229;border:1px solid #23313a;border-radius:10px;padding:.4rem .6rem}

    @media (max-width:900px){
      .app{grid-template-columns:1fr;grid-template-areas:"header" "chat" "composer"}
      .sidebar{display:none}
      .header{gap:.4rem}
      .reel{height:108px}
      .reel .cell{font-size:28px;height:36px}
      .slot-controls .input{max-width:98px}
    }

    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #24323b;padding:.5rem;text-align:left;font-size:.92rem}
    .table th{color:#b7c8d1;font-weight:700}
    .actions{display:flex;gap:.35rem;flex-wrap:wrap}

    .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#1f2c34;color:var(--text);padding:.5rem .75rem;border-radius:10px;border:1px solid #2a3942;box-shadow:var(--bubble-shadow);z-index:9999;display:none}
  </style>
</head>
<body>

<!-- AUTH VIEW (fresh) -->
<section id="authView" class="center-wrap">
  <div class="card">
    <h1>📧 Anmeldung</h1>
    <form id="authForm" novalidate>
      <div class="row">
        <input id="emailInput" class="input" type="email" placeholder="E-Mail" autocomplete="username" required/>
        <input id="passInput" class="input" type="password" placeholder="Passwort" autocomplete="current-password" required/>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button id="loginBtn" class="btn" type="submit" data-mode="login">Einloggen</button>
        <button id="registerBtn" class="btn secondary" type="button" data-mode="register">Registrieren</button>
      </div>
      <div style="display:flex;align-items:center;gap:.5rem;margin-top:.5rem">
        <input id="staySignedIn" type="checkbox" />
        <label for="staySignedIn" class="inline-help">Eingeloggt bleiben</label>
      </div>
      <div id="authError" class="inline-help" style="color:#ffb4a9;margin-top:.5rem"></div>
      <div style="margin-top:.75rem;display:flex;gap:.5rem">
        <button id="forceLoginScreenBtn" class="btn ghost" type="button">Login erzwingen</button>
        <button id="clearSessionBtn" class="btn ghost" type="button">Sitzung löschen</button>
      </div>
    </form>
  </div>
</section>

<!-- PROFILE SETUP VIEW -->
<section id="profileView" class="center-wrap hidden">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h1>👤 Konto erstellen</h1>
      <button id="switchAccountBtn" class="btn ghost" title="Zum Login zurück">Konto wechseln</button>
    </div>
    <p>Bild, Name, Geburtstag und <b>Status</b> (sichtbar für Freunde).</p>
    <div class="row" style="align-items:center; margin:.5rem 0">
      <img id="profilePhotoPreview" class="pfp-lg" alt="Profilbild">
      <div>
        <label class="label">Profilbild</label>
        <input type="file" id="profilePhotoInput" accept="image/*" class="input" />
      </div>
    </div>
    <label class="label" for="displayName">Name</label>
    <input id="displayName" class="input" placeholder="Dein Name" />
    <div class="row" style="margin-top:.5rem">
      <div>
        <label class="label" for="birthday">Geburtstag</label>
        <input id="birthday" type="date" class="input" />
      </div>
      <div>
        <label class="label" for="about">Status</label>
        <input id="about" class="input" placeholder="Hey there! I am using Chatty." />
      </div>
    </div>
    <button id="saveProfileBtn" class="btn" style="margin-top:1rem">Speichern & weiter</button>
  </div>
</section>

<!-- MAIN APP VIEW (unchanged core layout) -->
<section id="appView" class="app hidden">
  <aside class="sidebar">
    <div class="topbar">
      <div class="row" style="align-items:center;flex:1">
        <img id="mePhoto" class="pfp" alt="Ich" style="width:40px;height:40px;border-radius:50%;object-fit:cover">
        <div>
          <div id="meName" class="title"></div>
          <div id="meEmail" class="subtitle"></div>
        </div>
      </div>
      <button id="logoutBtn" class="btn ghost" title="Abmelden">⎋</button>
    </div>
    <div class="row" style="padding:.6rem">
      <input id="searchEmail" class="input" placeholder="E-Mail suchen" type="search"/>
    </div>
    <div class="row" style="padding:0 .6rem .6rem .6rem">
      <input id="searchName" class="input" placeholder="Name suchen" type="search"/>
      <button id="startChatBtn" class="btn">Chat</button>
    </div>
    <div id="chatList" class="list"></div>
  </aside>

  <header class="header">
    <div class="logo" title="Logo">
      <svg viewBox="0 0 100 100" aria-label="Logo" xmlns="http://www.w3.org/2000/svg">
        <rect width="100" height="100" fill="#000"/>
        <circle cx="50" cy="50" r="18" fill="#fff"/>
        <g stroke="#fff" stroke-width="6" stroke-linecap="round">
          <line x1="50" y1="6" x2="50" y2="22"/>
          <line x1="50" y1="78" x2="50" y2="94"/>
          <line x1="6" y1="50" x2="22" y2="50"/>
          <line x1="78" y1="50" x2="94" y2="50"/>
          <line x1="20" y1="20" x2="30" y2="30"/>
          <line x1="70" y1="70" x2="80" y2="80"/>
          <line x1="20" y1="80" x2="30" y2="70"/>
          <line x1="70" y1="30" x2="80" y2="20"/>
        </g>
      </svg>
    </div>
    <img id="peerPhoto" class="pfp" alt="Kontakt">
    <div>
      <div id="peerName" class="title">Wähle einen Chat</div>
      <div id="peerSubtitle" class="subtitle"></div>
    </div>
    <div class="right">
      <button id="openSearchBtn" class="icon-btn" title="Kontakte suchen">
        <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5 1.5-1.5-5-5zM9.5 14A4.5 4.5 0 119.5 5a4.5 4.5 0 010 9z"/></svg>
      </button>
      <button id="openTopBtn" class="icon-btn" title="Topliste">
        <svg viewBox="0 0 24 24"><path d="M7 21v-8H3V3h8v4h2V3h8v10h-4v8H7zM5 5v6h4V5H5zm10 2v4h4V7h-4zM9 13v6h6v-6H9z"/></svg>
      </button>
      <button id="slotBtn" class="icon-btn" title="Mini-Slot">
        <svg viewBox="0 0 24 24"><path d="M3 7a3 3 0 0 1 3-3h12a3 3 0 0 1 3 3v8a3 3 0 0 1-3 3h-1v2h-2v-2H9v2H7v-2H6a3 3 0 0 1-3-3V7zM6 6a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H6zm1.5 2.3h3v6h-3v-6zm6 0h3v6h-3v-6z"/></svg>
      </button>
      <button id="adminBtn" class="icon-btn hidden" title="Admin">
        <svg viewBox="0 0 24 24"><path d="M12 1l3 5 6 .9-4.3 4.2 1 6L12 15l-5.7 3 1-6L3 6.9 9 6l3-5z"/></svg>
      </button>
    </div>
  </header>

  <main id="chatArea" class="chat">
    <div style="text-align:center;color:var(--muted);margin-top:1rem">Kein Chat ausgewählt.</div>
  </main>

  <div class="composer">
    <label class="icon-btn" for="imageInput" title="Bild senden">
      <input id="imageInput" type="file" accept="image/*" />
      <svg viewBox="0 0 24 24"><path d="M21 19V5a2 2 0 0 0-2-2H5c-1.1 0-2 .9-2 2v14h18zM5 5h14v10l-3.5-3.5-2.5 2.5-4-4L5 13V5zm0 14h14v2H5v-2z"/></svg>
    </label>
    <button id="recBtn" class="icon-btn" title="Sprachnotiz aufnehmen">
      <svg id="micIcon" viewBox="0 0 24 24"><path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 14 0h-2zM11 19h2v3h-2v-3z"/></svg>
    </button>
    <input id="msgInput" class="input grow" placeholder="Nachricht" />
    <button id="sendBtn" class="btn">Senden</button>
  </div>
</section>

<!-- SEARCH MODAL -->
<div id="searchModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Suche">
  <div class="sheet">
    <header><h2>🔎 Kontakte suchen</h2><button id="searchClose" class="btn secondary">Schließen</button></header>
    <div class="row">
      <input id="searchNameModal" class="input" type="search" placeholder="Name"/>
      <input id="searchEmailModal" class="input" type="email" placeholder="E-Mail"/>
    </div>
    <div class="row" style="margin-top:.5rem">
      <button id="searchRunBtn" class="btn">Suchen</button>
      <button id="searchStartChatBtn" class="btn secondary">Chat starten</button>
    </div>
    <div id="searchResults" style="margin-top:.75rem"></div>
  </div>
</div>

<!-- SLOT MODAL -->
<div id="slotModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Mini Slot">
  <div class="sheet">
    <header>
      <h2>🎰 Mini-Slot – €-Guthaben & Bank</h2>
      <div class="row" style="flex:0 0 auto">
        <button id="slotClose" class="btn secondary">Schließen</button>
      </div>
    </header>
    <div class="kpis">
      <div class="kpi">Guthaben: <b id="slotBalance">€ 0</b></div>
      <div class="kpi">Letzter Gewinn: <b id="slotWin">€ 0</b></div>
      <div class="kpi">Gesamtgewinne: <b id="slotWinsTotal">€ 0</b></div>
      <div class="kpi">Bank: <b id="slotBankBalance">€ 0</b></div>
    </div>
    <div class="slot-wrap">
      <div id="reels" class="reels" aria-live="polite"></div>
      <div class="slot-controls">
        <label class="label" style="width:auto">Einsatz</label>
        <select id="slotBet" class="input" style="max-width:120px">
          <option>10</option><option>20</option><option>30</option><option>40</option><option>50</option>
          <option>60</option><option>70</option><option>80</option><option>90</option><option selected>100</option>
        </select>
        <button id="slotSpin" class="btn">SPIN</button>
        <button id="slotAuto10" class="btn secondary">Autospin ×10</button>
        <button id="bankBtn" class="btn secondary" title="Bank: Leihen / Zurückzahlen">🏦 Bank</button>
        <button id="slotRules" class="btn secondary">Regeln</button>
      </div>
    </div>
    <div class="leaderboard">
      <h3>🏆 Top 10 (Gesamtgewinne)</h3>
      <div id="lb"></div>
    </div>
  </div>
</div>

<!-- BANK MODAL -->
<div id="bankModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Bank">
  <div class="sheet">
    <header><h2>🏦 Bank – Leihen & Zurückzahlen</h2><button id="bankClose" class="btn secondary">Schließen</button></header>
    <div class="row">
      <div class="card" style="padding:1rem">
        <h3>Geld leihen</h3>
        <p class="inline-help">Max. 10.000 € pro Woche · Gesamtlimit 100.000 € offen</p>
        <div class="row">
          <input id="loanAmount" type="number" class="input small" placeholder="€" min="1" step="1" />
          <button id="loanDo" class="btn">Leihen</button>
        </div>
        <div class="chip" id="loanInfo"></div>
      </div>
      <div class="card" style="padding:1rem">
        <h3>Zurückzahlen</h3>
        <p class="inline-help">Von deinem Guthaben an die Bank</p>
        <div class="row">
          <input id="repayAmount" type="number" class="input small" placeholder="€" min="1" step="1" />
          <button id="repayDo" class="btn secondary">Zurückzahlen</button>
        </div>
        <div class="chip" id="repayInfo"></div>
      </div>
    </div>
  </div>
</div>

<!-- TOPLIST MODAL -->
<div id="topModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Topliste">
  <div class="sheet">
    <header><h2>🏆 Topliste</h2><button id="topClose" class="btn secondary">Schließen</button></header>
    <div id="lbQuick"></div>
  </div>
</div>

<!-- ADMIN MODAL -->
<div id="adminModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="Admin">
  <div class="sheet">
    <header><h2>🛠️ Admin-Menü</h2><button id="adminClose" class="btn secondary">Schließen</button></header>
    <div class="kpis">
      <div class="kpi">Bank-Saldo: <b id="bankBalanceLabel">€ 0</b></div>
    </div>

    <div class="row" style="margin-top:.5rem">
      <button id="admBankCreditBtn" class="btn secondary">Bank + Betrag</button>
      <button id="admBankDebitBtn" class="btn danger">Bank − Betrag</button>
      <input id="admAmount" class="input small" type="number" placeholder="€" />
    </div>

    <div class="row" style="margin-top:.5rem">
      <button id="admTopResetBtn" class="btn secondary">Topliste zurücksetzen</button>
      <button id="admHardResetBtn" class="btn danger">⚠️ Hard Reset (Alles zurücksetzen)</button>
    </div>

    <h3 style="margin-top:1rem">👥 Konten (live)</h3>
    <div class="row" style="margin:.25rem 0">
      <input id="admFilter" class="input" placeholder="Name oder E-Mail filtern" />
      <button id="admRefresh" class="btn secondary">Aktualisieren</button>
    </div>
    <div style="max-height:360px;overflow:auto;border:1px solid #23313a;border-radius:12px">
      <table class="table">
        <thead>
          <tr><th>Name</th><th>E-Mail</th><th>Guthaben</th><th>Wins</th><th>Loan offen</th><th>Aktionen</th></tr>
        </thead>
        <tbody id="adminUsers"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-storage-compat.js"></script>

<script>
// --- Global helpers ---
const $ = s => document.querySelector(s);
const toast = (msg, ms=2600) => { const el = $("#toast"); el.textContent = msg; el.style.display="block"; setTimeout(()=> el.style.display="none", ms); };
const showView = id => { ['authView','profileView','appView'].forEach(v=>$('#'+v).classList.add('hidden')); $('#'+id).classList.remove('hidden'); };
const fmtEUR = v => "€ " + (Math.round(v).toLocaleString());
const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));
const OWNER_EMAIL = "julian1339klausch@gmx.de";
const OWNER_ADMIN_CODE = "140318";

// --- Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyDN1MZv_q38Zoymt92BHWTe9sUNwteT1KA",
  authDomain: "sample-firebase-ai-app-b02a4.firebaseapp.com",
  projectId: "sample-firebase-ai-app-b02a4",
  storageBucket: "sample-firebase-ai-app-b02a4.firebasestorage.app",
  messagingSenderId: "382050648468",
  appId: "1:382050648468:web:8c6f34051a7b2991ebcf81"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(), db=firebase.firestore(), storage=firebase.storage();

// --- Env sanity (http + storage) ---
(function(){
  const isFile = location.protocol === 'file:';
  try{ localStorage.setItem('__t','1'); localStorage.removeItem('__t'); }catch(e){ toast('Browser speichert keine Sitzung.'); }
  if(isFile){ toast('Bitte über http://localhost öffnen – file:// blockiert Auth.'); }
})();

// --- Fresh Login window logic ---
const authForm = $('#authForm'), emailInput = $('#emailInput'), passInput = $('#passInput');
const loginBtn = $('#loginBtn'), registerBtn = $('#registerBtn');
const authError = $('#authError'), staySignedIn = $('#staySignedIn');

function setAuthBusy(b){
  loginBtn.disabled = b; registerBtn.disabled = b; emailInput.disabled = b; passInput.disabled = b;
}

authForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  await doAuth('login');
});
registerBtn.addEventListener('click', async ()=>{
  await doAuth('register');
});

async function doAuth(mode){
  try{
    authError.textContent='';
    const email=(emailInput.value||'').trim();
    const pass=(passInput.value||'').trim();
    if(!email || !pass){ authError.textContent='Bitte E-Mail & Passwort eingeben.'; return; }
    setAuthBusy(true);
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    if(mode==='register'){
      await auth.createUserWithEmailAndPassword(email, pass);
      toast('Konto erstellt – Profil anlegen.');
    }else{
      await auth.signInWithEmailAndPassword(email, pass);
      toast('Angemeldet.');
    }
    localStorage.setItem("staySignedIn", staySignedIn.checked ? "1" : "0");
  }catch(e){
    console.error(e);
    const code = e && e.code || '';
    const map = {
      'auth/invalid-email':'Ungültige E-Mail.',
      'auth/user-not-found':'Kein Konto gefunden. Bitte registrieren.',
      'auth/wrong-password':'Falsches Passwort.',
      'auth/invalid-credential':'Ungültige Zugangsdaten.',
      'auth/too-many-requests':'Zu viele Versuche – kurz warten.',
      'auth/network-request-failed':'Netzwerkfehler – ggf. Adblock/VPN.',
      'auth/unauthorized-domain':'Domain nicht autorisiert – Firebase Authorized domains.'
    };
    authError.textContent = map[code] || (e.message||'Login fehlgeschlagen');
  }finally{
    setAuthBusy(false);
  }
}

// --- Stay signed-in preference ---
(function(){ const stayPref = localStorage.getItem("staySignedIn") === "1"; if(!stayPref){ try{ auth.signOut(); }catch(e){} } })();

// --- Core app state/logic (kept; trimmed for brevity but functional) ---
let me=null, adminUnlocked=false;
function formatTime(d){ if(!d) return ''; const now=new Date(); const sameDay=d.toDateString()===now.toDateString(); return sameDay? d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : d.toLocaleDateString(); }

async function getAppConfig(){
  const ref = db.collection('app').doc('config');
  const snap = await ref.get();
  return snap.exists ? snap.data() : {};
}

function isoWeekKey(date=new Date()){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const day = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  const y = d.getUTCFullYear();
  return `${y}-W${String(weekNo).padStart(2,'0')}`;
}
function isMondayLocal(){ return new Date().getDay() === 1; }
async function maybeWeeklyToplistReset(){
  try{
    if(!isMondayLocal()) return;
    const cfgRef = db.collection('app').doc('config');
    const cfgSnap = await cfgRef.get();
    const cfg = cfgSnap.exists ? cfgSnap.data() : {};
    const thisWeek = isoWeekKey(new Date());
    if(cfg.lastToplistResetWeek === thisWeek) return;
    await cfgRef.set({ lastToplistResetWeek: thisWeek, lastToplistResetTs: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    const snap = await db.collection('users').get();
    let batch = db.batch(); let count = 0;
    snap.forEach(doc=>{
      batch.set(doc.ref, { slotWinsTotal: 0 }, { merge: true });
      count++; if(count % 400 === 0){ batch.commit(); batch = db.batch(); }
    });
    await batch.commit();
    toast("Topliste für diese Woche zurückgesetzt.");
  }catch(e){ console.error("Weekly reset error", e); }
}

// Switch account
$('#switchAccountBtn').addEventListener('click', async ()=>{ try{ await auth.signOut(); }catch(e){} showView('authView'); });

// Auth state
auth.onAuthStateChanged(async (user)=>{
  try{
    if(!user){ showView('authView'); return; }
    // MustRecreate gate
    const cfg = await getAppConfig();
    if(cfg && cfg.mustRecreate && user && user.email !== OWNER_EMAIL){
      const createdMs = (user.metadata && user.metadata.creationTime) ? Date.parse(user.metadata.creationTime) : 0;
      const resetMs = (typeof cfg.resetEpoch === 'number') ? cfg.resetEpoch : 0;
      if(resetMs && createdMs && createdMs < resetMs){
        try{ await auth.signOut(); }catch(e){}
        showView('authView'); toast('System-Reset aktiv – bitte neu registrieren.');
        return;
      }
    }
    const doc=await db.collection('users').doc(user.uid).get();
    me = doc.exists ? doc.data() : null;
    if(!me){ showView('profileView'); }
    else {
      showView('appView'); renderMe(me); startThreadsListener(); await loadEconomy(); await maybeWeeklyToplistReset(); if(user.email===OWNER_EMAIL) unlockAdminSilent(); subscribeLeaderboards();
    }
  }catch(err){ console.error(err); try{ await auth.signOut(); }catch(e){} showView('authView'); }
});

// Silent admin unlock (no hints). Button sichtbar erst nach Code-Eingabe durch Klick
function unlockAdminSilent(){
  const btn=$('#adminBtn'); if(!btn) return;
  btn.classList.remove('hidden');
  btn.addEventListener('click', ()=>{
    const code = prompt('Admin-Code eingeben:');
    if(code === OWNER_ADMIN_CODE){ adminUnlocked=true; toast('Admin freigeschaltet.'); openAdmin(); } else { toast('Falscher Code.'); }
  }, { once:true });
}

function renderMe(profile){
  $('#mePhoto').src = profile.photoURL || ('https://ui-avatars.com/api/?name=' + encodeURIComponent(profile.name||'Ich'));
  $('#meName').textContent = profile.name || 'Ich';
  $('#meEmail').textContent = profile.email || '';
}

// --- PROFILE SETUP ---
$('#profilePhotoInput').addEventListener('change', ()=>{
  const f=$('#profilePhotoInput').files?.[0]; if(!f){ $('#profilePhotoPreview').src=''; return; }
  const r=new FileReader(); r.onload=e=>$('#profilePhotoPreview').src=e.target.result; r.readAsDataURL(f);
});
$('#saveProfileBtn').addEventListener('click', async ()=>{
  try{
    const user=auth.currentUser; if(!user){ toast('Nicht angemeldet.'); return; }
    let name=($('#displayName').value||'').trim(); if(!name){ name = user.email || 'User'; $('#displayName').value=name; }
    const birthday=$('#birthday').value||null; const about=($('#about').value||'').trim()||null;
    let photoURL=null; const f=$('#profilePhotoInput').files?.[0]||null;
    if(f){ try{ const ext=(f.name.split('.').pop()||'jpg'); const ref=storage.ref().child(`pfp/${user.uid}.${ext}`); await ref.put(f); photoURL=await ref.getDownloadURL(); }catch(e){ console.warn('Bild-Upload fehlgeschlagen',e); } }
    const profile={ uid:user.uid, email:user.email||null, name, nameLower:name.toLowerCase(), birthday, about, photoURL:photoURL||null, slotBalance:1500, slotWinsTotal:0, slotLoanOutstanding:0, slotLoanWeekKey:null, slotLoanWeekAmount:0, createdAt:firebase.firestore.FieldValue.serverTimestamp(), updatedAt:firebase.firestore.FieldValue.serverTimestamp() };
    await db.collection('users').doc(user.uid).set(profile,{merge:true});
    me={...(me||{}),...profile};
    renderMe(me); showView('appView'); startThreadsListener(); await loadEconomy(); await maybeWeeklyToplistReset(); if(user.email===OWNER_EMAIL) unlockAdminSilent(); subscribeLeaderboards();
    toast('Profil gespeichert.');
  }catch(e){ console.error(e); toast('Konnte Profil nicht speichern.'); }
});

// --- CHAT (unchanged behavior summary) ---
function startThreadsListener(){
  const user=auth.currentUser; if(!user) return;
  db.collection('threads').where('participants','array-contains',user.uid).orderBy('lastMessageAt','desc').limit(50).onSnapshot(snap=>{
    const chatList=$('#chatList'); chatList.innerHTML='';
    snap.forEach(async doc=>{
      const t=doc.data(); const peerId=t.participants.find(id=>id!==user.uid);
      const peerDoc=await db.collection('users').doc(peerId).get();
      const peer=peerDoc.data()||{name:'Unbekannt',photoURL:null,email:'?'};
      const div=document.createElement('div'); div.className='chat-item';
      div.innerHTML=`<img class="pfp" src="${peer.photoURL||('https://ui-avatars.com/api/?name='+encodeURIComponent(peer.name))}" alt="pfp"><div class="meta"><div><div class="name">${peer.name}</div><div class="last">${t.lastMessageText || (t.lastMessageType==='image'?'🖼️ Bild':t.lastMessageType==='audio'?'🎤 Sprachnotiz':'') || ''}</div></div><div class="time">${formatTime(t.lastMessageAt?.toDate?.())}</div></div>`;
      div.addEventListener('click',()=>openThread(doc.id, peer)); chatList.appendChild(div);
    });
  });
}
let activeThreadId=null, activePeer=null, messagesUnsub=null;
async function openThread(threadId,peer){
  activeThreadId=threadId; activePeer=peer;
  $('#peerPhoto').src=peer.photoURL||('https://ui-avatars.com/api/?name='+encodeURIComponent(peer.name||'?'));
  $('#peerName').textContent=peer.name||peer.email||'Kontakt'; $('#peerSubtitle').textContent=peer.email||'';
  startMessagesListener(threadId);
}
function startMessagesListener(threadId){
  if(messagesUnsub) messagesUnsub();
  messagesUnsub=db.collection('threads').doc(threadId).collection('messages').orderBy('ts','asc').limit(200).onSnapshot(snap=>{
    const chatArea=$('#chatArea'); chatArea.innerHTML='';
    snap.forEach(doc=>{
      const m=doc.data();
      const div=document.createElement('div'); div.className='bubble '+(m.senderId===auth.currentUser?.uid?'me':'them');
      if(m.text){ const p=document.createElement('div'); p.textContent=m.text; div.appendChild(p); }
      if(m.imageUrl){ const img=document.createElement('img'); img.className='msg-image'; img.src=m.imageUrl; img.alt='Bild'; div.appendChild(img); }
      if(m.audioUrl){ const audio=document.createElement('audio'); audio.controls=true; audio.src=m.audioUrl; div.appendChild(audio); }
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=formatTime(m.ts?.toDate?.()); div.appendChild(meta);
      chatArea.appendChild(div);
    });
    const chatAreaEl=$('#chatArea'); chatAreaEl.scrollTop=chatAreaEl.scrollHeight;
  });
}
$('#startChatBtn').addEventListener('click', async ()=>{
  const email=($('#searchEmail').value||'').trim().toLowerCase();
  const name=($('#searchName').value||'').trim();
  let peer=null;
  if(email){ const q=await db.collection('users').where('email','==', email).limit(1).get(); if(!q.empty) peer=q.docs[0].data(); }
  if(!peer && name){
    const q=await db.collection('users').orderBy('nameLower').startAt(name.toLowerCase()).endAt(name.toLowerCase()+'\uf8ff').limit(5).get();
    if(!q.empty) peer=q.docs[0].data();
  }
  if(!peer){ toast('Kein Nutzer gefunden.'); return; }
  const id=[auth.currentUser.uid, peer.uid].sort().join('_');
  const ref=db.collection('threads').doc(id); const snap=await ref.get();
  if(!snap.exists){ await ref.set({participants:[auth.currentUser.uid,peer.uid],emails:[me.email||null,peer.email||null],createdAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageText:'',lastMessageType:''}); }
  await openThread(id, peer);
});

$('#sendBtn').addEventListener('click', sendText);
$('#msgInput').addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendText(); }});
async function sendText(){ const text=($('#msgInput').value||'').trim(); if(!text) return; if(!activeThreadId){ toast('Wähle zuerst einen Chat.'); return; } $('#msgInput').value=''; await pushMessage({ text }); }
$('#imageInput').addEventListener('change', async ()=>{ const f=$('#imageInput').files?.[0]; if(!f) return; if(!activeThreadId){ toast('Wähle zuerst einen Chat.'); $('#imageInput').value=''; return; } try{ const url=await uploadFile(f,'images'); await pushMessage({ imageUrl:url, type:'image' }); $('#imageInput').value=''; }catch(e){ console.error(e); toast('Upload fehlgeschlagen.'); } });
$('#recBtn').addEventListener('click', async ()=>{
  if(!activeThreadId){ toast('Wähle zuerst einen Chat.'); return; }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true}); const chunks=[]; const rec=new MediaRecorder(stream);
    rec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
    rec.onstop=async()=>{ const blob=new Blob(chunks,{type:'audio/webm'}); const file=new File([blob],`voice_${Date.now()}.webm`,{type:'audio/webm'}); const url=await uploadFile(file,'audio'); await pushMessage({audioUrl:url, type:'audio'}); };
    rec.start(); toast('🎤 Aufnahme… zum Beenden erneut tippen.'); $('#recBtn').onclick=()=>rec.stop();
  }catch(e){ console.error(e); toast('Mikrofonzugriff verweigert.'); }
});
async function uploadFile(file,folder){ const uid=auth.currentUser.uid; const safe=(file.name||'file').replace(/[^a-z0-9\._-]+/gi,'_').toLowerCase(); const ref=storage.ref().child(`${folder}/${uid}/${Date.now()}_${safe}`); await ref.put(file); return await ref.getDownloadURL(); }
async function pushMessage({text=null,imageUrl=null,audioUrl=null,type=null}){
  const user=auth.currentUser; if(!user||!activeThreadId) return;
  const msg={senderId:user.uid,text:text||null,imageUrl:imageUrl||null,audioUrl:audioUrl||null,ts:firebase.firestore.FieldValue.serverTimestamp(),type:type||(imageUrl?'image':audioUrl?'audio':'text')};
  const ref=db.collection('threads').doc(activeThreadId).collection('messages').doc(); await ref.set(msg);
  await db.collection('threads').doc(activeThreadId).set({lastMessageAt:firebase.firestore.FieldValue.serverTimestamp(),lastMessageText:text||(imageUrl?'🖼️ Bild':audioUrl?'🎤 Sprachnotiz':''),lastMessageType:msg.type},{merge:true});
}

// --- Economy / Bank / Slot (kept from previous working logic) ---
async function getBankDoc(){ const ref=db.collection('economy').doc('bank'); const snap=await ref.get(); if(!snap.exists){ await ref.set({ bankBalance: 1000000000, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), createdAt: firebase.firestore.FieldValue.serverTimestamp() }); return (await ref.get()).data(); } return snap.data(); }
async function setBankBalance(val){ await db.collection('economy').doc('bank').set({ bankBalance: Math.max(0, Math.floor(val)), updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); }
let slotBalance=0, slotWinsTotal=0, autospinLeft=0, spinning=false;

async function loadEconomy(){
  const user=auth.currentUser; if(!user) return;
  const bank=await getBankDoc(); $('#bankBalanceLabel').textContent = fmtEUR(bank.bankBalance||0); $('#slotBankBalance').textContent=fmtEUR(bank.bankBalance||0);
  const doc=await db.collection('users').doc(user.uid).get(); const data=doc.exists?doc.data():{};
  let sb = Number.isFinite(data.slotBalance) ? data.slotBalance : 0;
  let sw = Number.isFinite(data.slotWinsTotal) ? data.slotWinsTotal : 0;
  const todayKey = new Date().toISOString().slice(0,10);
  if(data.slotLastGrantDate !== todayKey){
    sb += 500;
    await db.collection('users').doc(user.uid).set({ slotBalance: sb, slotLastGrantDate: todayKey }, { merge:true });
    toast('Tagesguthaben +500 verbucht.');
  }
  slotBalance=sb; slotWinsTotal=sw; updateEconomyUI();
}
function updateEconomyUI(){ $('#slotBalance').textContent=fmtEUR(slotBalance); $('#slotWinsTotal').textContent=fmtEUR(slotWinsTotal); }
async function saveEconomy(){ const user=auth.currentUser; if(!user) return; await db.collection('users').doc(user.uid).set({ slotBalance, slotWinsTotal, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }); updateEconomyUI(); }

const SYMS=["🍒","🍋","🍇","🔔","⭐","7️⃣"];
const SYM_WEIGHTS=[30,25,20,15,7,3];
const BASELINE_BET=10, BASE_WIN_THREE=50, BASE_WIN_FULL=1000;

function buildReelsGrid(grid){
  const reelsEl=$('#reels'); reelsEl.innerHTML='';
  for(let c=0;c<3;c++){
    const col=document.createElement('div'); col.className='reel';
    for(let r=0;r<3;r++){
      const cell=document.createElement('div'); cell.className='cell'; cell.textContent=grid[r][c];
      col.appendChild(cell);
    }
    reelsEl.appendChild(col);
  }
}
function randomGrid(){
  const g=[[],[],[]];
  const total = SYM_WEIGHTS.reduce((a,b)=>a+b,0);
  const pick = ()=>{
    let r = Math.random()*total, i=0;
    for(; i<SYM_WEIGHTS.length; i++){ if((r-=SYM_WEIGHTS[i])<0) break; }
    return SYMS[i] || SYMS[0];
  };
  for(let c=0;c<3;c++){ for(let r=0;r<3;r++){ g[r][c]=pick(); } }
  return g;
}
function isFullScreen(grid){ const f=grid[0][0]; for(let r=0;r<3;r++){ for(let c=0;c<3;c++){ if(grid[r][c]!==f) return false; } } return true; }

$('#slotBtn').addEventListener('click', async ()=>{ await loadEconomy(); buildReelsGrid(randomGrid()); $('#slotWin').textContent=fmtEUR(0); $('#slotModal').classList.remove('hidden'); });
$('#slotClose').addEventListener('click', ()=>{ autospinLeft=0; $('#slotModal').classList.add('hidden'); });
$('#slotRules').addEventListener('click', ()=>{
  alert('Regeln:\n- 5 Gewinnlinien (rechts→links): 3 Reihen + 2 Diagonalen.\n- Nur 3 gleiche AUF EINER LINIE.\n- Linien addieren sich. Einsatz 10–100.\n- 1 sanfter Re-Spin nach einer 3er-Linie; Vollbild sehr selten.\n- Vollbild: Baseline €1000 (bei Einsatz 10).');
});
$('#bankBtn').addEventListener('click', async ()=>{ await refreshBankInfo(); $('#bankModal').classList.remove('hidden'); });
$('#bankClose').addEventListener('click', ()=> $('#bankModal').classList.add('hidden'));

async function refreshBankInfo(){
  const user=auth.currentUser; if(!user) return;
  const u=(await db.collection('users').doc(user.uid).get()).data()||{};
  const wk = isoWeekKey(new Date());
  const weekAmt = (u.slotLoanWeekKey===wk) ? (u.slotLoanWeekAmount||0) : 0;
  const remainWeek = clamp(10000 - weekAmt, 0, 10000);
  const outstanding = Math.max(0, u.slotLoanOutstanding||0);
  $('#loanInfo').textContent = `Verfügbar diese Woche: ${fmtEUR(remainWeek)} · Offen: ${fmtEUR(outstanding)}`;
  $('#repayInfo').textContent = `Offen: ${fmtEUR(outstanding)} · Dein Guthaben: ${fmtEUR(slotBalance)}`;
  const bank=await getBankDoc(); $('#slotBankBalance').textContent=fmtEUR(bank.bankBalance||0); $('#bankBalanceLabel').textContent=fmtEUR(bank.bankBalance||0);
}

$('#loanDo').addEventListener('click', async ()=>{
  const user=auth.currentUser; if(!user) return;
  let amt = Math.floor(+($('#loanAmount').value||0)); if(amt<=0){ toast('Betrag eingeben.'); return; }
  const uref = db.collection('users').doc(user.uid);
  const uSnap = await uref.get(); const u = uSnap.data()||{};
  const wk = isoWeekKey(new Date());
  const weekAmt = (u.slotLoanWeekKey===wk) ? (u.slotLoanWeekAmount||0) : 0;
  const weeklyLeft = Math.max(0, 10000 - weekAmt);
  let outstanding = Math.max(0, u.slotLoanOutstanding||0);
  if(outstanding >= 100000){ toast('Limit erreicht (100.000 € offen). Bitte zuerst mind. 10% zurückzahlen.'); return; }
  const maxByOutstanding = 100000 - outstanding;
  let allowed = Math.min(amt, weeklyLeft, maxByOutstanding);
  if(allowed<=0){ toast('Diese Woche kein Leihrahmen mehr verfügbar.'); return; }
  const bank = await getBankDoc();
  if((bank.bankBalance||0) < allowed){ toast('Bank hat aktuell nicht genug Guthaben.'); return; }
  outstanding += allowed;
  const newWeekAmt = weekAmt + allowed;
  slotBalance += allowed;
  await uref.set({ slotLoanOutstanding: outstanding, slotLoanWeekKey: wk, slotLoanWeekAmount: newWeekAmt, slotBalance }, { merge:true });
  await setBankBalance((bank.bankBalance||0)-allowed);
  await refreshBankInfo(); updateEconomyUI(); toast('Leihe ausgezahlt: '+fmtEUR(allowed));
});

$('#repayDo').addEventListener('click', async ()=>{
  const user=auth.currentUser; if(!user) return;
  let amt = Math.floor(+($('#repayAmount').value||0)); if(amt<=0){ toast('Betrag eingeben.'); return; }
  const uref = db.collection('users').doc(user.uid);
  const u = (await uref.get()).data()||{};
  let outstanding = Math.max(0, u.slotLoanOutstanding||0);
  if(outstanding<=0){ toast('Keine offenen Leihen.'); return; }
  amt = Math.min(amt, outstanding, slotBalance);
  if(amt<=0){ toast('Nicht genug Guthaben zum Zurückzahlen.'); return; }
  slotBalance -= amt; outstanding -= amt;
  await uref.set({ slotLoanOutstanding: outstanding, slotBalance }, { merge:true });
  const bank = await getBankDoc(); await setBankBalance((bank.bankBalance||0)+amt);
  await refreshBankInfo(); updateEconomyUI(); toast('Zurückgezahlt: '+fmtEUR(amt));
});

$('#slotSpin').addEventListener('click', async ()=>{ autospinLeft=0; await triggerSpin(); });
$('#slotAuto10').addEventListener('click', async ()=>{ if(spinning) return; autospinLeft=10; await triggerSpin(); });

async function triggerSpin(){
  if(spinning) return;
  const bet=parseInt($('#slotBet').value||'10',10);
  if(slotBalance < bet){ toast('Nicht genug Guthaben.'); autospinLeft=0; return; }
  slotBalance -= bet; await saveEconomy();
  const bank=await getBankDoc(); await setBankBalance((bank.bankBalance||0)+bet); $('#slotBankBalance').textContent=fmtEUR((bank.bankBalance||0)+bet); $('#bankBalanceLabel').textContent=fmtEUR((bank.bankBalance||0)+bet);
  spinning=true; $('#slotSpin').disabled=true;
  let steps=11; const t=setInterval(()=>{ buildReelsGrid(randomGrid()); steps--; if(steps<=0){ clearInterval(t); finishSpin(bet); } }, 95);
}
async function finishSpin(bet){
  let grid = randomGrid(); buildReelsGrid(grid);
  const LINES = [
    [[0,2],[0,1],[0,0]],
    [[1,2],[1,1],[1,0]],
    [[2,2],[2,1],[2,0]],
    [[0,2],[1,1],[2,0]],
    [[2,2],[1,1],[0,0]]
  ];
  const at=(r,c)=>grid[r][c];
  let baseWin=0, threeHitSym=null;
  for(const line of LINES){
    const s0=at(line[0][0],line[0][1]), s1=at(line[1][0],line[1][1]), s2=at(line[2][0],line[2][1]);
    if(s0===s1 && s1===s2){ baseWin += BASE_WIN_THREE; if(!threeHitSym) threeHitSym=s0; }
  }
  if(threeHitSym){
    for(let r=0;r<3;r++){ for(let c=0;c<3;c++){ if(grid[r][c]!==threeHitSym && Math.random()<0.15){ grid[r][c]=threeHitSym; } } }
    buildReelsGrid(grid);
    if(isFullScreen(grid)){ baseWin += BASE_WIN_FULL; }
  }
  const mult=Math.max(1, bet/BASELINE_BET);
  let win=Math.round(baseWin*mult);
  if(win>0){
    const bank=await getBankDoc();
    const pay=Math.min(win, bank.bankBalance||0);
    if(pay>0){
      slotBalance += pay; slotWinsTotal += pay; await saveEconomy();
      await setBankBalance((bank.bankBalance||0)-pay);
      $('#slotBankBalance').textContent=fmtEUR((bank.bankBalance||0)-pay);
      $('#bankBalanceLabel').textContent=fmtEUR((bank.bankBalance||0)-pay);
      if(pay<win){ toast('Bank hat nicht genug – Teilgewinn ausgezahlt.'); }
    } else { toast('Bank leer – kein Gewinn auszahlbar.'); win=0; }
  }
  $('#slotWin').textContent=fmtEUR(win);
  spinning=false; $('#slotSpin').disabled=false;
  if(autospinLeft>0){
    autospinLeft--;
    const nextBet=parseInt($('#slotBet').value||'10',10);
    if(slotBalance>=nextBet){ setTimeout(()=>{ triggerSpin(); }, 420); } else { autospinLeft=0; toast('Autospin gestoppt – Guthaben zu niedrig.'); }
  }
}

// --- Leaderboard live ---
let lbUnsub=null;
function subscribeLeaderboards(){
  if(lbUnsub) lbUnsub();
  lbUnsub = db.collection('users').orderBy('slotWinsTotal','desc').limit(10).onSnapshot(snap=>{
    const rows=[]; let i=1;
    snap.forEach(doc=>{ const u=doc.data(); rows.push(`<div class="row"><div>#${i}</div><div>${(u.name||'Anonym')}</div><div>${fmtEUR(u.slotWinsTotal||0)}</div></div>`); i++; });
    const html= rows.length? rows.join('') : '<div class="row"><div>Topliste erscheint, sobald Gewinne vorhanden sind.</div></div>';
    $('#lb').innerHTML=html; $('#lbQuick').innerHTML=html;
  });
}
$('#openTopBtn').addEventListener('click', ()=>{ $('#topModal').classList.remove('hidden'); });
$('#topClose').addEventListener('click', ()=> $('#topModal').classList.add('hidden'));

// --- Admin ---
function openAdmin(){ $('#adminModal').classList.remove('hidden'); refreshAdmin(); startAdminUsersList(); }
$('#adminClose').addEventListener('click', ()=>{ $('#adminModal').classList.add('hidden'); if(adminUsersUnsub){ adminUsersUnsub(); adminUsersUnsub=null; } });
async function refreshAdmin(){ const bank=await getBankDoc(); $('#bankBalanceLabel').textContent=fmtEUR(bank.bankBalance||0); }
$('#admBankCreditBtn').addEventListener('click', async ()=>{ if(!adminUnlocked) return; const amt=Math.floor(+($('#admAmount').value||0)); if(amt<=0){ toast('Betrag angeben.'); return; } const bank=await getBankDoc(); await setBankBalance((bank.bankBalance||0)+amt); await refreshAdmin(); toast('Bank + Betrag.'); });
$('#admBankDebitBtn').addEventListener('click', async ()=>{ if(!adminUnlocked) return; const amt=Math.floor(+($('#admAmount').value||0)); if(amt<=0){ toast('Betrag angeben.'); return; } const bank=await getBankDoc(); await setBankBalance(Math.max(0,(bank.bankBalance||0)-amt)); await refreshAdmin(); toast('Bank − Betrag.'); });
$('#admTopResetBtn').addEventListener('click', async ()=>{
  if(!adminUnlocked) return;
  if(!confirm('Topliste (Gesamtgewinne) für alle Nutzer auf 0 setzen?')) return;
  try{
    const snap = await db.collection('users').get();
    let batch = db.batch(); let count=0;
    snap.forEach(doc=>{ batch.set(doc.ref, { slotWinsTotal: 0 }, { merge:true }); count++; if(count % 400 === 0){ batch.commit(); batch = db.batch(); } });
    await batch.commit();
    const wk = isoWeekKey(new Date());
    await db.collection('app').doc('config').set({ lastToplistResetWeek: wk, lastToplistResetTs: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    toast('Topliste manuell zurückgesetzt.');
  }catch(e){ console.error(e); toast('Fehler beim Zurücksetzen der Topliste.'); }
});
$('#admHardResetBtn').addEventListener('click', async ()=>{
  if(!adminUnlocked){ toast('Kein Admin.'); return; }
  if(!confirm('⚠️ HARD RESET: Alle Nicht-Admin-Konten werden gelöscht, Bank auf 1.000.000.000 €, Statistiken zurückgesetzt. Fortfahren?')) return;
  try{
    await db.collection('economy').doc('bank').set({ bankBalance: 1000000000, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
    const now = Date.now();
    await db.collection('app').doc('config').set({ mustRecreate: true, resetEpoch: now }, { merge:true });
    const usersSnap = await db.collection('users').get();
    let batch = db.batch(); let ops=0;
    usersSnap.forEach(doc => {
      const d = doc.data();
      const isOwner = (d.email && d.email.toLowerCase() === OWNER_EMAIL.toLowerCase());
      if(isOwner){
        batch.set(doc.ref, { slotBalance:1500, slotWinsTotal:0, slotLoanOutstanding:0, slotLoanWeekKey:null, slotLoanWeekAmount:0, updatedAt:firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });
      } else {
        batch.delete(doc.ref);
      }
      ops++; if(ops % 400 === 0){ batch.commit(); batch = db.batch(); }
    });
    await batch.commit(); await refreshAdmin(); toast('Hard Reset abgeschlossen.');
  }catch(e){ console.error(e); toast('Fehler beim Hard Reset.'); }
});
let adminUsersUnsub=null;
function startAdminUsersList(){
  if(adminUsersUnsub) adminUsersUnsub();
  adminUsersUnsub = db.collection('users').orderBy('nameLower').limit(200).onSnapshot(snap=>{
    const filter=($('#admFilter').value||'').trim().toLowerCase();
    const rows=[];
    snap.forEach(doc=>{
      const u=doc.data();
      if(filter && !((u.name||'').toLowerCase().includes(filter) || (u.email||'').toLowerCase().includes(filter))) return;
      rows.push(`<tr data-uid="${u.uid}">
        <td>${u.name||'Anonym'}</td>
        <td>${u.email||''}</td>
        <td>${fmtEUR(u.slotBalance||0)}</td>
        <td>${fmtEUR(u.slotWinsTotal||0)}</td>
        <td>${fmtEUR(u.slotLoanOutstanding||0)}</td>
        <td class="actions">
          <button class="btn secondary" data-act="give">Geben</button>
          <button class="btn secondary" data-act="take">Abziehen</button>
          <button class="btn danger" data-act="delete">Löschen</button>
        </td>
      </tr>`);
    });
    $('#adminUsers').innerHTML = rows.join('') || '<tr><td colspan="6">Keine Nutzer gefunden.</td></tr>';
    $('#adminUsers').querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const tr=btn.closest('tr'); const uid=tr.getAttribute('data-uid'); const act=btn.getAttribute('data-act');
        if(act==='give') return adminGive(uid);
        if(act==='take') return adminTake(uid);
        if(act==='delete') return adminDelete(uid);
      });
    });
  });
}
async function adminGive(uid){
  if(!adminUnlocked) return;
  const amountStr = prompt('Betrag dem Nutzer geben (€):'); if(!amountStr) return;
  const amount = Math.max(0, Math.floor(+amountStr||0)); if(amount<=0) return;
  const bank=await getBankDoc(); if((bank.bankBalance||0) < amount){ toast('Bank hat nicht genug Guthaben.'); return; }
  const ref=db.collection('users').doc(uid); const snap=await ref.get(); if(!snap.exists){ toast('Nutzer nicht gefunden.'); return; }
  const bal = Math.max(0, snap.data().slotBalance||0);
  await ref.set({ slotBalance: bal + amount }, { merge:true });
  await setBankBalance((bank.bankBalance||0)-amount);
  await refreshAdmin(); toast('Guthaben vergeben: '+fmtEUR(amount));
}
async function adminTake(uid){
  if(!adminUnlocked) return;
  const amountStr = prompt('Betrag beim Nutzer abziehen (€):'); if(!amountStr) return;
  const amount = Math.max(0, Math.floor(+amountStr||0)); if(amount<=0) return;
  const ref=db.collection('users').doc(uid); const snap=await ref.get(); if(!snap.exists){ toast('Nutzer nicht gefunden.'); return; }
  const bal = Math.max(0, snap.data().slotBalance||0);
  const take = Math.min(amount, bal);
  if(take<=0){ toast('Kein Guthaben vorhanden.'); return; }
  await ref.set({ slotBalance: bal - take }, { merge:true });
  const bank=await getBankDoc(); await setBankBalance((bank.bankBalance||0)+take); await refreshAdmin();
  toast('Abgezogen: '+fmtEUR(take));
}
async function adminDelete(uid){
  if(!adminUnlocked) return;
  if(!confirm('Nutzer wirklich löschen? Guthaben geht an die Bank zurück.')) return;
  const ref=db.collection('users').doc(uid); const snap=await ref.get(); if(!snap.exists){ toast('Nutzer nicht gefunden.'); return; }
  const d=snap.data(); if(d.email && d.email.toLowerCase()===OWNER_EMAIL.toLowerCase()){ toast('Admin kann nicht gelöscht werden.'); return; }
  const bal = Math.max(0, d.slotBalance||0);
  const bank=await getBankDoc(); await setBankBalance((bank.bankBalance||0)+bal);
  await ref.delete(); await refreshAdmin();
  toast('Nutzer gelöscht. Guthaben an Bank zurück.');
}

// --- Quick modals ---
$('#openSearchBtn').addEventListener('click', ()=>{ $('#searchModal').classList.remove('hidden'); $('#searchResults').innerHTML=''; });
$('#searchClose').addEventListener('click', ()=> $('#searchModal').classList.add('hidden'));
$('#openTopBtn').addEventListener('click', ()=>{ $('#topModal').classList.remove('hidden'); });
$('#topClose').addEventListener('click', ()=> $('#topModal').classList.add('hidden'));
$('#logoutBtn').addEventListener('click', async ()=>{ try{ await auth.signOut(); localStorage.setItem("staySignedIn","0"); }catch(e){} showView('authView'); });
$('#forceLoginScreenBtn').addEventListener('click', async ()=>{ localStorage.setItem("staySignedIn","0"); try{ await auth.signOut(); }catch(e){} toast("Login-Bildschirm erzwungen."); showView("authView"); });
$('#clearSessionBtn').addEventListener('click', async ()=>{ try{ await auth.signOut(); localStorage.removeItem("staySignedIn"); }catch(e){} toast("Sitzung gelöscht."); showView("authView"); });

// Defaults
$('#profilePhotoPreview').src='https://ui-avatars.com/api/?name=Du';
</script>
</body>
</html>
